scenario_id: "mr_ontobot_diagnostic_ya_relations"
name: "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ø-–û—Ç–Ω–æ—à–µ–Ω–∏—è"
description: "–¢—Ä–µ—Ç–∏–π —ç—Ç–∞–ø –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤ - —Å—Ñ–µ—Ä–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π —Å –ª—é–¥—å–º–∏ –∏ –º–∏—Ä–æ–º"

initial_context:
  current_diagnostic_stage: "ya_relations"
  ya_relations_response: null
  examples_viewed: false

steps:
  - id: start
    type: start
    next_step: send_intro_message

  - id: send_intro_message
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: "–¢–µ–ø–µ—Ä—å –ø–æ—Å–º–æ—Ç—Ä–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –∏ –≤—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞–Ω–∏–µ."
    next_step: send_ya_relations_video

  - id: send_ya_relations_video
    type: channel_action
    params:
      action: forward_message
      chat_id: "{chat_id}"
      from_chat_id: "-1002614708769"
      message_id: 5  # ID –≤–∏–¥–µ–æ "–ó–∞–¥–∞–Ω–∏–µ –Ø-–û—Ç–Ω–æ—à–µ–Ω–∏—è" - —á–µ—Ç–≤–µ—Ä—Ç–æ–µ –≤–∏–¥–µ–æ –≤ –∫–∞–Ω–∞–ª–µ
    next_step: show_ya_relations_options

  - id: show_ya_relations_options
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–ü–æ—Å–º–æ—Ç—Ä–∏ –≤–∏–¥–µ–æ –∏ –≤—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞–Ω–∏–µ"
      buttons:
        - text: "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–º–µ—Ä—ã –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤"
          callback_data: "view_ya_relations_examples"
        - text: "–ù–∞–ø–∏—Å–∞—Ç—å –ú—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã –Ø-–û—Ç–Ω–æ—à–µ–Ω–∏—è"
          callback_data: "write_ya_relations_viruses"
    next_step: wait_for_choice

  - id: wait_for_choice
    type: input_button
    params:
      variable: "user_choice"
      timeout_seconds: 3600
    next_step: process_choice

  - id: process_choice
    type: branch
    params:
      conditions:
        - condition: "{callback_data} == 'view_ya_relations_examples'"
          next_step: show_examples
        - condition: "{callback_data} == 'write_ya_relations_viruses'"
          next_step: provide_instructions
      default_next_step: show_examples

  - id: show_examples
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: "üìä –ü—Ä–∏–º–µ—Ä—ã –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤ ¬´–Ø-–û—Ç–Ω–æ—à–µ–Ω–∏—è¬ª"
      # TODO: –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∏ –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞
    next_step: update_examples_viewed

  - id: update_examples_viewed
    type: action
    params:
      action_type: "update_context"
      updates:
        examples_viewed: true
    next_step: offer_writing_after_examples

  - id: offer_writing_after_examples
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ –Ω–∞–ø–∏—Å–∞–Ω–∏—é —Å–≤–æ–∏—Ö –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤"
      buttons:
        - text: "–ù–∞–ø–∏—Å–∞—Ç—å –ú—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã –Ø-–û—Ç–Ω–æ—à–µ–Ω–∏—è"
          callback_data: "write_ya_relations_viruses"
    next_step: wait_for_writing_choice

  - id: wait_for_writing_choice
    type: input_button
    params:
      variable: "user_choice"
      timeout_seconds: 3600
    next_step: provide_instructions

  - id: provide_instructions
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        –ö–∞–∫ –ø–∏—Å–∞—Ç—å –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã "–Ø –∏ –û—Ç–Ω–æ—à–µ–Ω–∏—è (—Å –ú–∏—Ä–æ–º –∏ –õ—é–¥—å–º–∏)":

        ü§ù **–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏:** –ü–æ–¥—É–º–∞–π—Ç–µ –æ –≤–∞—à–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º, —Å–µ–º—å–µ–π, –¥—Ä—É–∑—å—è–º–∏, –∫–æ–ª–ª–µ–≥–∞–º–∏, –∏ –≤ —Ü–µ–ª–æ–º —Å –ª—é–¥—å–º–∏ –∏ –º–∏—Ä–æ–º –≤–æ–∫—Ä—É–≥.

        üò∞ **–í—ã—è–≤–ª—è–π—Ç–µ —Å—Ç—Ä–∞—Ö–∏ –∏ –Ω–µ–¥–æ–≤–µ—Ä–∏–µ:** –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –º—ã—Å–ª–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ —Å—Ç—Ä–∞—Ö–æ–º –±–ª–∏–∑–æ—Å—Ç–∏, –ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞, –æ—Ç–≤–µ—Ä–∂–µ–Ω–∏—è, –æ—Å—É–∂–¥–µ–Ω–∏—è, –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤. –§–∏–∫—Å–∏—Ä—É–π—Ç–µ –æ–±—â–µ–µ –Ω–µ–¥–æ–≤–µ—Ä–∏–µ –∫ –ª—é–¥—è–º –∏–ª–∏ –º–∏—Ä—É.

        üö´ **–§–∏–∫—Å–∏—Ä—É–π—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏–µ —É–±–µ–∂–¥–µ–Ω–∏—è –æ–± –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö:** –õ—é–±—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ —Ç–æ–º, –∫–∞–∫–∏–º–∏ "–¥–æ–ª–∂–Ω—ã" –∏–ª–∏ "–Ω–µ –¥–æ–ª–∂–Ω—ã" –±—ã—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —á—Ç–æ "–≤—Å–µ–≥–¥–∞" –∏–ª–∏ "–Ω–∏–∫–æ–≥–¥–∞" –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –Ω–∏—Ö ("–í—Å–µ –º—É–∂—á–∏–Ω—ã/–∂–µ–Ω—â–∏–Ω—ã...", "–õ—é–±–æ–≤—å –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–Ω–æ—Å–∏—Ç –±–æ–ª—å", "–ù–∏–∫–æ–º—É –Ω–µ–ª—å–∑—è –¥–æ–≤–µ—Ä—è—Ç—å").

        üíî **–û—Ç–º–µ—á–∞–π—Ç–µ –º—ã—Å–ª–∏ –æ —Å–≤–æ–µ–π —Ä–æ–ª–∏ –∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö:** –ï—Å–ª–∏ —Å—á–∏—Ç–∞–µ—Ç–µ, —á—Ç–æ –≤–∞—Å "–Ω–µ –ø–æ–Ω–∏–º–∞—é—Ç", "–Ω–µ —Ü–µ–Ω—è—Ç", "–Ω–µ –ª—é–±—è—Ç —Ç–∞–∫–∏–º, –∫–∞–∫–æ–π –≤—ã –µ—Å—Ç—å", –∏–ª–∏ —á—Ç–æ –≤—ã "–¥–æ–ª–∂–Ω—ã" –∑–∞—Å–ª—É–∂–∏—Ç—å –ª—é–±–æ–≤—å ‚Äì –∑–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ.

        üîÑ **–û–ø–∏—Å—ã–≤–∞–π—Ç–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:** –ï—Å–ª–∏ –∑–∞–º–µ—á–∞–µ—Ç–µ, —á—Ç–æ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö —Å —Ä–∞–∑–Ω—ã–º–∏ –ª—é–¥—å–º–∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –ø—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ –≤—ã–∑—ã–≤–∞—é—Ç —Å—Ö–æ–∂–∏–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –º—ã—Å–ª–∏ ‚Äì —ç—Ç–æ –≤–∞–∂–Ω—ã–µ "–º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã".

        **–ü—Ä–∏–º–µ—Ä—ã –¥–ª—è —Å—Ç–∞—Ä—Ç–∞:**
        ‚Ä¢ "–Ø –±–æ—é—Å—å –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –ª—é–¥—è–º"
        ‚Ä¢ "–ú–µ–Ω—è –≤—Å–µ —Ä–∞–≤–Ω–æ –±—Ä–æ—Å—è—Ç"
        ‚Ä¢ "–ù–∏–∫—Ç–æ –º–µ–Ω—è –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç"
        ‚Ä¢ "–û—Ç–Ω–æ—à–µ–Ω–∏—è ‚Äì —ç—Ç–æ –≤—Å–µ–≥–¥–∞ —Å–ª–æ–∂–Ω–æ –∏ –±–æ–ª—å–Ω–æ"
        ‚Ä¢ "–ß—Ç–æ–±—ã –º–µ–Ω—è –ª—é–±–∏–ª–∏, —è –¥–æ–ª–∂–µ–Ω(–Ω–∞) –±—ã—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–º(–æ–π)"

        –ì–ª–∞–≤–Ω–æ–µ ‚Äì –∑–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Ç–µ –º—ã—Å–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–µ—à–∞—é—Ç –≤–∞–º —Å—Ç—Ä–æ–∏—Ç—å –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–µ, –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –≤—ã–∑—ã–≤–∞—é—Ç –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, —Å—Ç—Ä–∞—Ö –∏–ª–∏ —á—É–≤—Å—Ç–≤–æ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–∞ –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –ª—é–¥—å–º–∏ –∏ –º–∏—Ä–æ–º.
    next_step: request_ya_relations_input

  - id: request_ya_relations_input
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏ —Å–≤–æ–∏ –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã –≤ —Å—Ñ–µ—Ä–µ ¬´–Ø-–û—Ç–Ω–æ—à–µ–Ω–∏—è¬ª. –ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —á–µ—Å—Ç–µ–Ω —Å —Å–æ–±–æ–π."
      buttons:
        - text: "–ù–∞–ø–∏—Å–∞—Ç—å –ø–æ—Å–ª–µ –≤–∏—Ä—É—Å–∞ ¬´–Ø. –û—Ç–Ω–æ—à–µ–Ω–∏—è¬ª"
          callback_data: "ready_to_write"
    next_step: wait_for_ready_signal

  - id: wait_for_ready_signal
    type: input_button
    params:
      variable: "user_choice"
      timeout_seconds: 3600
    next_step: collect_ya_relations_response

  - id: collect_ya_relations_response
    type: input_text
    params:
      variable: "ya_relations_response"
      prompt: "–ù–∞–ø–∏—à–∏ —Å–≤–æ–∏ –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã ¬´–Ø-–û—Ç–Ω–æ—à–µ–Ω–∏—è¬ª:"
      timeout_seconds: 3600  # 1 —á–∞—Å –Ω–∞ –æ—Ç–≤–µ—Ç
    next_step: save_ya_relations_response

  - id: save_ya_relations_response
    type: action
    params:
      action_type: "update_context"
      updates:
        ya_relations_response: "{ya_relations_response}"
    next_step: save_to_database

  - id: save_to_database
    type: mongo_insert_document
    params:
      collection: "diagnostic_responses"
      document:
        user_id: "{user_id}"
        chat_id: "{chat_id}"
        stage: "ya_relations"
        response: "{ya_relations_response}"
        timestamp: "{current_timestamp}"
        session_id: "{session_id}"
    next_step: update_amocrm_contact

  - id: update_amocrm_contact
    type: amocrm_update_contact
    params:
      contact_id: "{amocrm_contact.contact_id}"
      custom_fields:
        DIAGNOSTIC_STAGE: "ya_relations_completed"
        YA_RELATIONS_RESPONSE: "{ya_relations_response}"
        YA_RELATIONS_COMPLETED_AT: "{current_timestamp}"
        DIAGNOSTIC_COMPLETED: "true"
      output_var: "amocrm_update_result"
    next_step: add_ya_relations_note

  - id: add_ya_relations_note
    type: amocrm_add_note
    params:
      entity_type: "contacts"
      entity_id: "{amocrm_contact.contact_id}"
      note_type: "common"
      text: |
        ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ "–Ø-–û—Ç–Ω–æ—à–µ–Ω–∏—è" –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        üéâ –í–°–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!
        
        üìÖ –î–∞—Ç–∞: {current_timestamp}
        üìù –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
        {ya_relations_response}
        
        –°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø: –°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ—Å—å–µ
    next_step: complete_diagnostic

  - id: complete_diagnostic
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        –ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –æ—Ç–≤–µ—Ç—ã.

        –Ø —É–∂–µ —Ä–∞–±–æ—Ç–∞—é –Ω–∞–¥ —Ç–≤–æ–∏–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –∏ –ø—Ä–æ–≥–Ω–æ–∑–∞–º–∏. –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª—é —Ç–µ–±–µ –∑–¥–µ—Å—å –≤ —Ç–µ—á–µ–Ω–∏–µ 30-60 –º–∏–Ω—É—Ç. –°–ª–µ–¥–∏ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ—Ç –º–µ–Ω—è.

        –ê –µ—â–µ —è –∑–∞–±–æ—á—É—Å—å –æ —Ç–æ–º, —á—Ç–æ–±—ã —Ç—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–ª—É—á–∏–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏. –ü–æ—ç—Ç–æ–º—É, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å —Å–≤–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ –Ω–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç¬ª.
    next_step: start_dossier_generation

  - id: start_dossier_generation
    type: scheduler_create_task
    params:
      task_type: "generate_dossier"
      delay_minutes: 45  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ—Å—å–µ —á–µ—Ä–µ–∑ 45 –º–∏–Ω—É—Ç
      task_data:
        user_id: "{user_id}"
        chat_id: "{chat_id}"
        session_id: "{session_id}"
    next_step: update_stage_and_switch

  - id: update_stage_and_switch
    type: action
    params:
      action_type: "update_context"
      updates:
        current_stage: "waiting_contact"
        diagnostic_completed: true
        dossier_generation_started: "{current_timestamp}"
    next_step: switch_to_contact_collection

  - id: switch_to_contact_collection
    type: switch_scenario
    params:
      scenario_id: "mr_ontobot_contact_collection"
      preserve_context: true
    next_step: end

  - id: end
    type: end 