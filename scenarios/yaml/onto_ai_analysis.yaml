scenario_id: onto_ai_analysis
description: "–ò–ò –∞–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è"
version: "1.0"

steps:
  - id: start
    type: start
    next_step: load_user_data

  - id: load_user_data
    type: mongo_find_one_document
    params:
      collection: users
      filter:
        telegram_user_id: "{user_id}"
    next_step: prepare_analysis_prompt

  - id: prepare_analysis_prompt
    type: action
    params:
      analysis_prompt: |
        –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å:
        
        –ò–º—è: {mongo_result.name}
        –í–æ–∑—Ä–∞—Å—Ç: {mongo_result.age}
        –ü—Ä–æ—Ñ–µ—Å—Å–∏—è: {mongo_result.profession}
        –¶–µ–ª–∏: {mongo_result.goals}
        –í—ã–∑–æ–≤—ã: {mongo_result.challenges}
        –ú–æ—Ç–∏–≤–∞—Ü–∏—è: {mongo_result.motivation}
        
        –°–æ–∑–¥–∞–π –∞–Ω–∞–ª–∏–∑ –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º:
        1. –¢–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏ (–∫—Ä–∞—Ç–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞)
        2. –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è
        3. –ö–ª—é—á–µ–≤—ã–µ –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è
        4. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫–æ—É—á–∏–Ω–≥–∞
        5. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
        6. –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
        
        –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º.
    next_step: run_ai_analysis

  - id: run_ai_analysis
    type: llm_query
    params:
      prompt: "{analysis_prompt}"
      model: "gpt-4"
      max_tokens: 1000
      temperature: 0.7
    next_step: save_analysis_to_mongo

  - id: save_analysis_to_mongo
    type: mongo_update_document
    params:
      collection: users
      filter:
        telegram_user_id: "{user_id}"
      document:
        ai_analysis: "{llm_response}"
        ai_analysis_date: "{current_timestamp}"
        profile_created: true
    next_step: save_analysis_to_amocrm

  - id: save_analysis_to_amocrm
    type: amocrm_add_note
    params:
      entity_type: "contact"
      entity_id: "{amocrm_contact_id}"
      text: |
        ü§ñ –ò–ò –ê–ù–ê–õ–ò–ó –õ–ò–ß–ù–û–°–¢–ò:
        
        {llm_response}
        
        –î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: {current_timestamp}
      note_type: "common"
    next_step: prepare_summary

  - id: prepare_summary
    type: action
    params:
      summary_prompt: |
        –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–∑–¥–∞–π –∫—Ä–∞—Ç–∫—É—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {mongo_result.name}:
        
        –ê–Ω–∞–ª–∏–∑: {llm_response}
        
        –°–æ–∑–¥–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –∫–æ—Ç–æ—Ä–æ–µ:
        1. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ –º—ã –ø–æ–Ω–∏–º–∞–µ–º –µ–≥–æ –ª–∏—á–Ω–æ—Å—Ç—å
        2. –í—ã–¥–µ–ª—è–µ—Ç –≥–ª–∞–≤–Ω—ã–µ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
        3. –ú—è–≥–∫–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –æ–±–ª–∞—Å—Ç–∏ —Ä–æ—Å—Ç–∞
        4. –ú–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –∫ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—é –ø—Ä–æ–≥—Ä–∞–º–º—ã
        
        –¢–æ–Ω: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π.
    next_step: generate_user_summary

  - id: generate_user_summary
    type: llm_query
    params:
      prompt: "{summary_prompt}"
      model: "gpt-4"
      max_tokens: 300
      temperature: 0.8
    next_step: send_analysis_results

  - id: send_analysis_results
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        ü§ñ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!
        
        {llm_response}
        
        üéØ –ì–æ—Ç–æ–≤—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É –ø—Ä–æ–≥—Ä–∞–º–º—ã?
      parse_mode: HTML
    next_step: offer_next_step

  - id: offer_next_step
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
      buttons:
        - text: "üöÄ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É"
          callback_data: "continue_program"
        - text: "üìä –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ–± –∞–Ω–∞–ª–∏–∑–µ"
          callback_data: "detailed_analysis"
        - text: "‚è∏Ô∏è –ü–∞—É–∑–∞"
          callback_data: "pause_program"
    next_step: wait_choice

  - id: wait_choice
    type: input
    params:
      variable: user_choice
      validation: "required"
    next_step: process_choice

  - id: process_choice
    type: branch
    params:
      condition: "{user_choice}"
      cases:
        "continue_program": continue_to_access_check
        "detailed_analysis": show_detailed_analysis
        "pause_program": pause_program

  - id: continue_to_access_check
    type: switch_scenario
    params:
      scenario_id: onto_access_check
      reason: "User chose to continue program"

  - id: show_detailed_analysis
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üìä –ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–∞—à–µ–π –ª–∏—á–Ω–æ—Å—Ç–∏:
        
        {ai_analysis}
        
        üí° –≠—Ç–æ—Ç –∞–Ω–∞–ª–∏–∑ –ø–æ–º–æ–∂–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à—É –ø—Ä–æ–≥—Ä–∞–º–º—É —Ä–∞–∑–≤–∏—Ç–∏—è.
      parse_mode: HTML
    next_step: offer_continue

  - id: offer_continue
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–ì–æ—Ç–æ–≤—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?"
      buttons:
        - text: "üöÄ –î–∞, –ø—Ä–æ–¥–æ–ª–∂–∏–º!"
          callback_data: "continue_program"
        - text: "‚è∏Ô∏è –°–¥–µ–ª–∞—é –ø–∞—É–∑—É"
          callback_data: "pause_program"
    next_step: wait_continue_choice

  - id: wait_continue_choice
    type: input
    params:
      variable: continue_choice
      validation: "required"
    next_step: process_continue_choice

  - id: process_continue_choice
    type: branch
    params:
      condition: "{continue_choice}"
      cases:
        "continue_program": continue_to_access_check
        "pause_program": pause_program

  - id: pause_program
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        ‚è∏Ô∏è –•–æ—Ä–æ—à–æ, {mongo_result.name}!
        
        üì± –í—ã –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–æ–≥—Ä–∞–º–º–µ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.
        –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ "–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã.
        
        üìß –ú—ã —Ç–∞–∫–∂–µ –ø—Ä–∏—à–ª–µ–º –≤–∞–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π.
      parse_mode: HTML
    next_step: schedule_reminder

  - id: schedule_reminder
    type: scheduler_create_task
    params:
      task_id: "reminder_{user_id}"
      delay_seconds: 259200  # 3 –¥–Ω—è
      scenario_id: "onto_reminder"
      context:
        user_id: "{user_id}"
        chat_id: "{chat_id}"
        reminder_type: "program_continuation"
    next_step: end

  - id: end
    type: end 