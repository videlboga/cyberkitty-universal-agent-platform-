{
  "scenario_id": "neuroexpert_flow",
  "name": "–ù–µ–π—Ä–æ–≠–∫—Å–ø–µ—Ä—Ç",
  "description": "–†–µ—à–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á —Å –ø–æ—à–∞–≥–æ–≤—ã–º –∞–Ω–∞–ª–∏–∑–æ–º –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π",
  "version": "1.0",
  
  "steps": [
    {
      "id": "start",
      "type": "start",
      "next_step": "load_user_context"
    },
    {
      "id": "load_user_context",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_mongo_find_data",
        "context_updates": {
          "collection": "users",
          "filter": {"user_id": "{user_id}"},
          "find_one": true,
          "output_var": "user_profile"
        }
      },
      "next_step": "log_task"
    },
    {
      "id": "log_task",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_log_message",
        "context_updates": {
          "message": "–ù–µ–π—Ä–æ–≠–∫—Å–ø–µ—Ä—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–ø—Ä–æ—Å–∏–ª —Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏: {message_text}",
          "level": "INFO",
          "category": "neuroexpert"
        }
      },
      "next_step": "analyze_task_complexity"
    },
    {
      "id": "analyze_task_complexity",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_llm_query",
        "context_updates": {
          "prompt": "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏ –ø–æ–¥—Ö–æ–¥ –∫ —Ä–µ—à–µ–Ω–∏—é:\n\n–ó–∞–¥–∞—á–∞: {message_text}\n\n–û–ø—Ä–µ–¥–µ–ª–∏:\n1. –¢–∏–ø –∑–∞–¥–∞—á–∏ (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è, –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–∞—è, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è)\n2. –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (1-5)\n3. –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–Ω–∞–Ω–∏—è\n4. –ü–æ–¥—Ö–æ–¥ –∫ —Ä–µ—à–µ–Ω–∏—é\n\n–û—Ç–≤–µ—Ç—å –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:\n{\n  \"task_type\": \"—Ç–∏–ø\",\n  \"complexity\": —á–∏—Å–ª–æ,\n  \"required_knowledge\": [\"–æ–±–ª–∞—Å—Ç—å1\", \"–æ–±–ª–∞—Å—Ç—å2\"],\n  \"approach\": \"–æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∞\"\n}",
          "model": "meta-llama/llama-3.2-70b-instruct",
          "temperature": 0.1,
          "max_tokens": 500,
          "output_var": "task_analysis"
        }
      },
      "next_step": "search_similar_solutions"
    },
    {
      "id": "search_similar_solutions",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_rag_search",
        "context_updates": {
          "query": "{message_text} —Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞",
          "collection": "expert_solutions",
          "limit": 3,
          "threshold": 0.6,
          "output_var": "similar_solutions"
        }
      },
      "next_step": "check_user_level"
    },
    {
      "id": "check_user_level",
      "type": "conditional_branch",
      "params": {
        "condition": "exists({user_profile})",
        "if_true_step": "generate_personalized_solution",
        "if_false_step": "generate_generic_solution"
      }
    },
    {
      "id": "generate_personalized_solution",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_llm_query",
        "context_updates": {
          "prompt": "–¢—ã - –ù–µ–π—Ä–æ–≠–∫—Å–ø–µ—Ä—Ç. –†–µ—à–∏ –∑–∞–¥–∞—á—É –ø–æ—à–∞–≥–æ–≤–æ, —É—á–∏—Ç—ã–≤–∞—è —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n–ó–∞–¥–∞—á–∞: {message_text}\n\n–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n- –û–ø—ã—Ç: {user_profile.experience_level}\n- –¶–µ–ª–∏: {user_profile.learning_goals}\n- –ò–Ω—Ç–µ—Ä–µ—Å—ã: {user_profile.interests}\n\n–ê–Ω–∞–ª–∏–∑ –∑–∞–¥–∞—á–∏: {task_analysis}\n–ü–æ—Ö–æ–∂–∏–µ —Ä–µ—à–µ–Ω–∏—è: {similar_solutions}\n\n–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ—à–µ–Ω–∏—é:\n1. –ê–¥–∞–ø—Ç–∏—Ä—É–π —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n2. –î–∞–π –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ\n3. –û–±—ä—è—Å–Ω–∏ –∫–∞–∂–¥—ã–π —à–∞–≥\n4. –ü—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã\n5. –î–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n6. –£–∫–∞–∂–∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏\n\n–§–æ—Ä–º–∞—Ç: HTML —Å —ç–º–æ–¥–∑–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.",
          "model": "meta-llama/llama-3.2-70b-instruct",
          "temperature": 0.2,
          "max_tokens": 2000,
          "output_var": "expert_solution"
        }
      },
      "next_step": "save_solution"
    },
    {
      "id": "generate_generic_solution",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_llm_query",
        "context_updates": {
          "prompt": "–¢—ã - –ù–µ–π—Ä–æ–≠–∫—Å–ø–µ—Ä—Ç. –†–µ—à–∏ –∑–∞–¥–∞—á—É –ø–æ—à–∞–≥–æ–≤–æ:\n\n–ó–∞–¥–∞—á–∞: {message_text}\n\n–ê–Ω–∞–ª–∏–∑ –∑–∞–¥–∞—á–∏: {task_analysis}\n–ü–æ—Ö–æ–∂–∏–µ —Ä–µ—à–µ–Ω–∏—è: {similar_solutions}\n\n–î–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏. –í–∫–ª—é—á–∏:\n1. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã\n2. –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ\n3. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã\n4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã\n5. –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏\n\n–§–æ—Ä–º–∞—Ç: HTML —Å —ç–º–æ–¥–∑–∏.",
          "model": "meta-llama/llama-3.2-70b-instruct",
          "temperature": 0.2,
          "max_tokens": 2000,
          "output_var": "expert_solution"
        }
      },
      "next_step": "save_solution"
    },
    {
      "id": "save_solution",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_mongo_save_data",
        "context_updates": {
          "collection": "expert_solutions",
          "document": {
            "user_id": "{user_id}",
            "chat_id": "{chat_id}",
            "task": "{message_text}",
            "solution": "{expert_solution}",
            "task_analysis": "{task_analysis}",
            "personalized": "exists({user_profile})",
            "created_at": "{current_time}"
          }
        }
      },
      "next_step": "send_solution"
    },
    {
      "id": "send_solution",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_message",
        "context_updates": {
          "text": "üß† <b>–†–µ—à–µ–Ω–∏–µ –æ—Ç –ù–µ–π—Ä–æ–≠–∫—Å–ø–µ—Ä—Ç–∞:</b>\n\n{expert_solution}",
          "parse_mode": "HTML"
        }
      },
      "next_step": "offer_clarification"
    },
    {
      "id": "offer_clarification",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_buttons",
        "context_updates": {
          "text": "ü§î <b>–ù—É–∂–Ω—ã —É—Ç–æ—á–Ω–µ–Ω–∏—è?</b>",
          "buttons": [
            [{"text": "üí° –û–±—ä—è—Å–Ω–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ", "callback_data": "explain_more"}],
            [{"text": "üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ", "callback_data": "alternative_solution"}],
            [{"text": "üìù –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä", "callback_data": "practical_example"}],
            [{"text": "‚úÖ –í—Å–µ –ø–æ–Ω—è—Ç–Ω–æ", "callback_data": "expert_done"}]
          ]
        }
      },
      "next_step": "wait_clarification_choice"
    },
    {
      "id": "wait_clarification_choice",
      "type": "input",
      "params": {
        "input_type": "callback_query",
        "timeout_seconds": 180,
        "output_var": "clarification_choice"
      },
      "next_step": "handle_clarification"
    },
    {
      "id": "handle_clarification",
      "type": "conditional_branch",
      "params": {
        "condition": "{clarification_choice} == 'explain_more'",
        "if_true_step": "detailed_explanation",
        "if_false_step": "check_alternative"
      }
    },
    {
      "id": "check_alternative",
      "type": "conditional_branch",
      "params": {
        "condition": "{clarification_choice} == 'alternative_solution'",
        "if_true_step": "alternative_solution",
        "if_false_step": "check_example"
      }
    },
    {
      "id": "check_example",
      "type": "conditional_branch",
      "params": {
        "condition": "{clarification_choice} == 'practical_example'",
        "if_true_step": "practical_example",
        "if_false_step": "end"
      }
    },
    {
      "id": "detailed_explanation",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_llm_query",
        "context_updates": {
          "prompt": "–î–∞–π –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:\n\n–ò—Å—Ö–æ–¥–Ω–∞—è –∑–∞–¥–∞—á–∞: {message_text}\n–†–µ—à–µ–Ω–∏–µ: {expert_solution}\n\n–û–±—ä—è—Å–Ω–∏ –∫–∞–∂–¥—ã–π —à–∞–≥ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ, –¥–æ–±–∞–≤—å —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –Ω—é–∞–Ω—Å—ã.\n\n–§–æ—Ä–º–∞—Ç: HTML —Å —ç–º–æ–¥–∑–∏.",
          "model": "meta-llama/llama-3.2-70b-instruct",
          "temperature": 0.3,
          "max_tokens": 1500,
          "output_var": "detailed_explanation_text"
        }
      },
      "next_step": "send_detailed_explanation"
    },
    {
      "id": "send_detailed_explanation",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_message",
        "context_updates": {
          "text": "üìñ <b>–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ:</b>\n\n{detailed_explanation_text}",
          "parse_mode": "HTML"
        }
      },
      "next_step": "end"
    },
    {
      "id": "alternative_solution",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_llm_query",
        "context_updates": {
          "prompt": "–ü—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –∑–∞–¥–∞—á–∏:\n\n–ó–∞–¥–∞—á–∞: {message_text}\n–ü–µ—Ä–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ: {expert_solution}\n\n–î–∞–π —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –¥—Ä—É–≥–æ–π –ø–æ–¥—Ö–æ–¥ –∫ —Ä–µ—à–µ–Ω–∏—é —ç—Ç–æ–π –∑–∞–¥–∞—á–∏. –û–±—ä—è—Å–Ω–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞.\n\n–§–æ—Ä–º–∞—Ç: HTML —Å —ç–º–æ–¥–∑–∏.",
          "model": "meta-llama/llama-3.2-70b-instruct",
          "temperature": 0.5,
          "max_tokens": 1500,
          "output_var": "alternative_solution_text"
        }
      },
      "next_step": "send_alternative_solution"
    },
    {
      "id": "send_alternative_solution",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_message",
        "context_updates": {
          "text": "üîÑ <b>–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:</b>\n\n{alternative_solution_text}",
          "parse_mode": "HTML"
        }
      },
      "next_step": "end"
    },
    {
      "id": "practical_example",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_llm_query",
        "context_updates": {
          "prompt": "–°–æ–∑–¥–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ä–µ—à–µ–Ω–∏—è:\n\n–ó–∞–¥–∞—á–∞: {message_text}\n–†–µ—à–µ–Ω–∏–µ: {expert_solution}\n\n–î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä —Å –∫–æ–¥–æ–º, –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π, –≥–¥–µ —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ.\n\n–§–æ—Ä–º–∞—Ç: HTML —Å —ç–º–æ–¥–∑–∏.",
          "model": "meta-llama/llama-3.2-70b-instruct",
          "temperature": 0.4,
          "max_tokens": 1500,
          "output_var": "practical_example_text"
        }
      },
      "next_step": "send_practical_example"
    },
    {
      "id": "send_practical_example",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_message",
        "context_updates": {
          "text": "üíª <b>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä:</b>\n\n{practical_example_text}",
          "parse_mode": "HTML"
        }
      },
      "next_step": "end"
    },
    {
      "id": "end",
      "type": "end"
    }
  ]
} 