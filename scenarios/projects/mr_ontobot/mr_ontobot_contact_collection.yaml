scenario_id: "mr_ontobot_contact_collection"
name: "–°–±–æ—Ä –ö–æ–Ω—Ç–∞–∫—Ç–æ–≤"
description: "–°—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è —Å–±–æ—Ä–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–∏—Å—Ç–µ–º–æ–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π"

initial_context:
  contact_request_sent: false
  contact_provided: false
  phone_number: null

steps:
  - id: start
    type: start
    next_step: request_contact

  - id: request_contact
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üìû **–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º**
        
        –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞:
      reply_markup:
        keyboard:
          - - text: "üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º"
              request_contact: true
        resize_keyboard: true
        one_time_keyboard: true
    next_step: update_request_sent

  - id: update_request_sent
    type: action
    params:
      action_type: "update_context"
      updates:
        contact_request_sent: "{current_timestamp}"
    next_step: schedule_contact_reminders

  - id: schedule_contact_reminders
    type: scheduler_create_task
    params:
      task_type: "send_push_reminder"
      delay_minutes: 30
      task_data:
        user_id: "{user_id}"
        chat_id: "{chat_id}"
        reminder_type: "contact_push_1"
    next_step: schedule_reminder_2

  - id: schedule_reminder_2
    type: scheduler_create_task
    params:
      task_type: "send_push_reminder"
      delay_minutes: 60
      task_data:
        user_id: "{user_id}"
        chat_id: "{chat_id}"
        reminder_type: "contact_push_2"
    next_step: schedule_reminder_3

  - id: schedule_reminder_3
    type: scheduler_create_task
    params:
      task_type: "send_push_reminder"
      delay_minutes: 90
      task_data:
        user_id: "{user_id}"
        chat_id: "{chat_id}"
        reminder_type: "contact_push_3"
    next_step: wait_for_contact

  - id: wait_for_contact
    type: input_text
    params:
      variable: "contact_data"
      prompt: "–û—Ç–ø—Ä–∞–≤—å —Å–≤–æ–π –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:"
      timeout_seconds: 7200  # 2 —á–∞—Å–∞ –æ–∂–∏–¥–∞–Ω–∏—è
    next_step: process_contact

  - id: process_contact
    type: action
    params:
      action_type: "update_context"
      updates:
        contact_provided: true
        phone_number: "{contact_data}"
    next_step: save_contact

  - id: save_contact
    type: mongo_insert_document
    params:
      collection: "user_contacts"
      document:
        user_id: "{user_id}"
        chat_id: "{chat_id}"
        phone_number: "{phone_number}"
        provided_at: "{current_timestamp}"
        session_id: "{session_id}"
    next_step: update_amocrm_contact

  - id: update_amocrm_contact
    type: amocrm_update_contact
    params:
      contact_id: "{amocrm_contact.contact_id}"
      custom_fields:
        PHONE: "{phone_number}"
        CONTACT_PROVIDED: "true"
        CONTACT_PROVIDED_AT: "{current_timestamp}"
        CURRENT_STAGE: "waiting_dossier"
      output_var: "amocrm_update_result"
    next_step: add_contact_note

  - id: add_contact_note
    type: amocrm_add_note
    params:
      entity_type: "contacts"
      entity_id: "{amocrm_contact.contact_id}"
      note_type: "common"
      text: |
        üìû –ö–æ–Ω—Ç–∞–∫—Ç –ø–æ–ª—É—á–µ–Ω!
        
        üìÖ –î–∞—Ç–∞: {current_timestamp}
        üì± –¢–µ–ª–µ—Ñ–æ–Ω: {phone_number}
        
        –°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ—Å—å–µ
    next_step: thank_for_contact

  - id: thank_for_contact
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        –°–ª–∞–≤–Ω–æ! –ê —Ç–µ–ø–µ—Ä—å, –ø–æ–∫–∞ —Ç—ã –æ–∂–∏–¥–∞–µ—à—å –¥–æ—Å—å–µ, —Å–∫–∞–∂–∏, —É —Ç–µ–±—è –µ—Å—Ç—å –Ω–∞–≤–µ—Ä–Ω—è–∫–∞ —Ä–æ–¥–Ω—ã–µ –∏ –±–ª–∏–∑–∫–∏–µ –ª—é–¥–∏, –∫–æ—Ç–æ—Ä—ã–º —Ç–æ–∂–µ –±—É–¥–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—å–µ –∏ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã. 
        
        –ï—Å–ª–∏ –¥–∞, —Ç–æ –∂–º–∏ –∫–Ω–æ–ø–∫—É ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –î–û–ë–†–û–ú¬ª –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É —Å–≤–æ–µ–º—É –æ–∫—Ä—É–∂–µ–Ω–∏—é. –ê —Ç–∞–∫–∂–µ, –ø–æ–ø—Ä–æ—Å–∏ –∏—Ö –Ω–∞–ø–∏—Å–∞—Ç—å, —á—Ç–æ –æ–Ω–∏ –æ—Ç —Ç–µ–±—è üòä
    next_step: offer_sharing

  - id: offer_sharing
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–ü–æ–¥–µ–ª–∏—Å—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å –±–ª–∏–∑–∫–∏–º–∏:"
      buttons:
        - - text: "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –î–û–ë–†–û–ú"
            callback_data: "share_bot"
            switch_inline_query: "–ü—Ä–∏–≤–µ—Ç! –ü–æ–ª—É—á–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤ –æ—Ç @mr_ontobot - —ç—Ç–æ –æ—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –°–∫–∞–∑–∞–ª, —á—Ç–æ –æ—Ç –º–µ–Ω—è üòä"
    next_step: update_stage_and_wait

  - id: update_stage_and_wait
    type: action
    params:
      action_type: "update_context"
      updates:
        current_stage: "waiting_dossier"
    next_step: wait_for_dossier_ready

  - id: wait_for_dossier_ready
    type: input_text
    params:
      variable: "system_event"
      prompt: "–û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–æ—Å—å–µ..."
      timeout_seconds: 7200  # 2 —á–∞—Å–∞ –º–∞–∫—Å–∏–º—É–º –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    next_step: switch_to_dossier_feedback

  - id: switch_to_dossier_feedback
    type: switch_scenario
    params:
      scenario_id: "mr_ontobot_dossier_feedback"
      preserve_context: true
    next_step: end

  # –û–±—Ä–∞–±–æ—Ç–∫–∞ push-–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
  - id: send_contact_push_1
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        –Ø —É–∂–µ —Ñ–æ—Ä–º–∏—Ä—É—é –¥–ª—è —Ç–µ–±—è –¥–æ—Å—å–µ. –°–∫–æ—Ä–µ–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π –∫–æ–Ω—Ç–∞–∫—Ç, —á—Ç–æ–±—ã —è —Å–º–æ–≥ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–±–µ —Ñ–∞–π–ª.
      reply_markup:
        keyboard:
          - - text: "üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º"
              request_contact: true
        resize_keyboard: true
        one_time_keyboard: true
    next_step: wait_for_contact

  - id: send_contact_push_2
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        –î–æ—Å—å–µ –ø–æ—á—Ç–∏ –≤ –ø—É—Ç–∏. –û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç¬ª.
      reply_markup:
        keyboard:
          - - text: "üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º"
              request_contact: true
        resize_keyboard: true
        one_time_keyboard: true
    next_step: wait_for_contact

  - id: send_contact_push_3
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        –í–∞–∂–Ω–æ–µ –¥–æ—Å—å–µ –æ —Å–µ–±–µ –ø–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ. –û—Å—Ç–∞–ª–æ—Å—å —Å–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –µ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è. –ñ–º–∏ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç¬ª.
      reply_markup:
        keyboard:
          - - text: "üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º"
              request_contact: true
        resize_keyboard: true
        one_time_keyboard: true
    next_step: wait_for_contact

  - id: end
    type: end 