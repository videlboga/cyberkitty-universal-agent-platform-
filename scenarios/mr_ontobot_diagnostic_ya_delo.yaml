scenario_id: "mr_ontobot_diagnostic_ya_delo"
name: "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ø-–î–µ–ª–æ"
description: "–í—Ç–æ—Ä–æ–π —ç—Ç–∞–ø –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤ - —Å—Ñ–µ—Ä–∞ –∫–∞—Ä—å–µ—Ä—ã –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π"

initial_context:
  current_diagnostic_stage: "ya_delo"
  ya_delo_response: null
  examples_viewed: false

steps:
  - id: start
    type: start
    next_step: send_ya_delo_video

  - id: send_ya_delo_video
    type: channel_action
    params:
      action: forward_message
      chat_id: "{chat_id}"
      from_chat_id: "-1002614708769"
      message_id: 5
    next_step: show_ya_delo_options

  - id: show_ya_delo_options
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–ü–æ—Å–º–æ—Ç—Ä–∏ –≤–∏–¥–µ–æ –∏ –≤—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞–Ω–∏–µ"
      buttons:
        - - text: "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–º–µ—Ä—ã –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤"
            callback_data: "view_ya_delo_examples"
        - - text: "–ù–∞–ø–∏—Å–∞—Ç—å –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã ¬´–Ø-–î–µ–ª–æ¬ª"
            callback_data: "write_ya_delo_viruses"
    next_step: wait_for_choice

  - id: wait_for_choice
    type: input
    params:
      waiting_for: "callback_query"
      expected_values: ["view_ya_delo_examples", "write_ya_delo_viruses"]
    next_step: process_choice

  - id: process_choice
    type: branch
    params:
      conditions:
        - condition: "callback_data == 'view_ya_delo_examples'"
          next_step: show_examples
        - condition: "callback_data == 'write_ya_delo_viruses'"
          next_step: provide_instructions
      default_next_step: show_examples

  - id: show_examples
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üìä **–ü—Ä–∏–º–µ—Ä—ã –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤ ¬´–Ø-–î–µ–ª–æ¬ª:**
        
        ‚Ä¢ "–Ø –Ω–µ –º–æ–≥—É –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–æ–ª—å—à–µ"
        ‚Ä¢ "–£—Å–ø–µ—Ö —Ç—Ä–µ–±—É–µ—Ç –∂–µ—Ä—Ç–≤"
        ‚Ä¢ "–ú–Ω–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è"
        ‚Ä¢ "–Ø –Ω–µ —Å–æ–∑–¥–∞–Ω –¥–ª—è –±–∏–∑–Ω–µ—Å–∞"
        ‚Ä¢ "–î–µ–Ω—å–≥–∏ –ø–æ—Ä—Ç—è—Ç –ª—é–¥–µ–π"
        ‚Ä¢ "–Ø –±–æ—é—Å—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏"
        ‚Ä¢ "–£ –º–µ–Ω—è –Ω–µ—Ç —Å–≤—è–∑–µ–π"
        ‚Ä¢ "–ú–Ω–µ —É–∂–µ –ø–æ–∑–¥–Ω–æ –º–µ–Ω—è—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏—é"
        
        –¢–µ–ø–µ—Ä—å –Ω–∞–π–¥–∏ —Å–≤–æ–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤ –∫–∞—Ä—å–µ—Ä–µ!
    next_step: update_examples_viewed

  - id: update_examples_viewed
    type: action
    params:
      action_type: "update_context"
      updates:
        examples_viewed: true
    next_step: provide_instructions

  - id: provide_instructions
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üìù **–ó–∞–¥–∞–Ω–∏–µ ¬´–Ø-–î–µ–ª–æ¬ª**
        
        –ù–∞–ø–∏—à–∏ 5-10 —Å–≤–æ–∏—Ö –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤ –æ –∫–∞—Ä—å–µ—Ä–µ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ö - —É–±–µ–∂–¥–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–µ—à–∞—é—Ç —Ç–µ–±–µ –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å—Ñ–µ—Ä–µ.
        
        –≠—Ç–æ –º–æ–≥—É—Ç –±—ã—Ç—å –º—ã—Å–ª–∏ –æ:
        ‚Ä¢ –î–µ–Ω—å–≥–∞—Ö –∏ –¥–æ—Ö–æ–¥–∞—Ö
        ‚Ä¢ –ö–∞—Ä—å–µ—Ä–Ω–æ–º —Ä–æ—Å—Ç–µ
        ‚Ä¢ –ë–∏–∑–Ω–µ—Å–µ –∏ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å—Å—Ç–≤–µ
        ‚Ä¢ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞–≤—ã–∫–∞—Ö
        ‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö
        
        –ë—É–¥—å —á–µ—Å—Ç–Ω—ã–º - —ç—Ç–æ –∫–ª—é—á –∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ.
        
        –ù–∞–ø–∏—à–∏ —Å–≤–æ–π –æ—Ç–≤–µ—Ç –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º:
    next_step: wait_for_response

  - id: wait_for_response
    type: input
    params:
      waiting_for: "text"
      timeout_seconds: 3600
      variable: "response_text"
    next_step: save_ya_delo_response

  - id: save_ya_delo_response
    type: mongo_upsert_document
    params:
      collection: "ontobot_responses"
      filter:
        user_id: "{user_id}"
      document:
        user_id: "{user_id}"
        chat_id: "{chat_id}"
        response_type: "ya_delo"
        response_text: "{response_text}"
        completed_at: "{current_timestamp}"
    next_step: find_amocrm_contact_ya_delo

  - id: find_amocrm_contact_ya_delo
    type: amocrm_find_contact
    params:
      query: "{user_id}"
      output_var: amocrm_contact_search
    next_step: update_amocrm_contact_ya_delo

  - id: update_amocrm_contact_ya_delo
    type: amocrm_update_contact
    params:
      contact_id: "{amocrm_contact_search.contact.id}"
      custom_fields:
        DIAGNOSTIC_STAGE: "ya_delo_completed"
        YA_DELO_RESPONSE: "{response_text}"
        YA_DELO_COMPLETED_AT: "{current_timestamp}"
      used_fields_map: true
      output_var: amocrm_update_result
    next_step: add_ya_delo_note

  - id: add_ya_delo_note
    type: amocrm_add_note
    params:
      entity_type: "contacts"
      entity_id: "{amocrm_contact_search.contact.id}"
      note_type: "common"
      note_text: "‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ \"–Ø-–î–µ–ª–æ\" –∑–∞–≤–µ—Ä—à–µ–Ω–∞\n\nüìÖ –î–∞—Ç–∞: {current_timestamp}\nüë§ –ò–º—è: {contact.first_name} {contact.last_name}\nüí≠ –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {response_text}\n\nüéØ –≠—Ç–∞–ø 2/3 –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω."
      output_var: note_result
    next_step: switch_to_ya_relations

  - id: switch_to_ya_relations
    type: switch_scenario
    params:
      scenario_id: "mr_ontobot_diagnostic_ya_relations"
      context:
        ya_ya_response: "{ya_ya_response}"
        ya_delo_response: "{response_text}"
        user_id: "{user_id}"
        chat_id: "{chat_id}"
    next_step: end

  - id: end
    type: end 