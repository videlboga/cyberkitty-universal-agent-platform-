scenario_id: "mr_ontobot_diagnostic_ya_delo"
name: "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ø-–î–µ–ª–æ"
description: "–í—Ç–æ—Ä–æ–π —ç—Ç–∞–ø –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤ - —Å—Ñ–µ—Ä–∞ —Ä–∞–±–æ—Ç—ã –∏ –∫–∞—Ä—å–µ—Ä—ã"

initial_context:
  current_diagnostic_stage: "ya_delo"
  ya_delo_response: null
  examples_viewed: false

steps:
  - id: start
    type: start
    next_step: send_ya_delo_video

  - id: send_ya_delo_video
    type: channel_action
    params:
      action: forward_message
      chat_id: "{chat_id}"
      from_chat_id: "-1002614708769"
      message_id: 4  # ID –≤–∏–¥–µ–æ "–ó–∞–¥–∞–Ω–∏–µ –Ø-–î–µ–ª–æ" - —Ç—Ä–µ—Ç—å–µ –≤–∏–¥–µ–æ –≤ –∫–∞–Ω–∞–ª–µ
    next_step: show_ya_delo_options

  - id: show_ya_delo_options
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–ü–æ—Å–º–æ—Ç—Ä–∏ –≤–∏–¥–µ–æ –∏ –≤—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞–Ω–∏–µ"
      buttons:
        - text: "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–º–µ—Ä—ã –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤"
          callback_data: "view_ya_delo_examples"
        - text: "–ù–∞–ø–∏—Å–∞—Ç—å –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã ¬´–Ø-–î–µ–ª–æ¬ª"
          callback_data: "write_ya_delo_viruses"
    next_step: wait_for_choice

  - id: wait_for_choice
    type: input_button
    params:
      variable: "user_choice"
      timeout_seconds: 3600
    next_step: process_choice

  - id: process_choice
    type: branch
    params:
      conditions:
        - condition: "{callback_data} == 'view_ya_delo_examples'"
          next_step: show_examples
        - condition: "{callback_data} == 'write_ya_delo_viruses'"
          next_step: provide_instructions
      default_next_step: show_examples

  - id: show_examples
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: "üìä –ü—Ä–∏–º–µ—Ä—ã –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤ ¬´–Ø-–î–µ–ª–æ¬ª"
      # TODO: –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∏ –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞
    next_step: update_examples_viewed

  - id: update_examples_viewed
    type: action
    params:
      action_type: "update_context"
      updates:
        examples_viewed: true
    next_step: offer_writing_after_examples

  - id: offer_writing_after_examples
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ –Ω–∞–ø–∏—Å–∞–Ω–∏—é —Å–≤–æ–∏—Ö –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤"
      buttons:
        - text: "–ù–∞–ø–∏—Å–∞—Ç—å –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã ¬´–Ø-–î–µ–ª–æ¬ª"
          callback_data: "write_ya_delo_viruses"
    next_step: wait_for_writing_choice

  - id: wait_for_writing_choice
    type: input_button
    params:
      variable: "user_choice"
      timeout_seconds: 3600
    next_step: provide_instructions

  - id: provide_instructions
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        –ö–∞–∫ –ø–∏—Å–∞—Ç—å –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã "–Ø-–î–µ–ª–æ":

        üéØ **–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ —Ä–∞–±–æ—Ç–µ/–±–∏–∑–Ω–µ—Å–µ/–∫–∞—Ä—å–µ—Ä–µ/—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–µ:** –ü–æ–¥—É–º–∞–π—Ç–µ –æ –≤–∞—à–µ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, —Ü–µ–ª—è—Ö, –∞–º–±–∏—Ü–∏—è—Ö, –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–±–æ—Ç—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö.

        üò∞ **–í—ã—è–≤–ª—è–π—Ç–µ —Å—Ç—Ä–∞—Ö–∏ –∏ —Å–æ–º–Ω–µ–Ω–∏—è:** –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –º—ã—Å–ª–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ —Å—Ç—Ä–∞—Ö–æ–º –Ω–µ—É–¥–∞—á–∏, –∫—Ä–∏—Ç–∏–∫–∏, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–≥–æ, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è.

        üö´ **–§–∏–∫—Å–∏—Ä—É–π—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏–µ —É–±–µ–∂–¥–µ–Ω–∏—è:** –õ—é–±—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–µ—à–∞—é—Ç –≤–∞–º –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å, —Ä–∞—Å—Ç–∏, –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–æ–ª—å—à–µ, –ø—Ä–æ—è–≤–ª—è—Ç—å —Å–µ–±—è ("–≠—Ç–æ –Ω–µ –¥–ª—è –º–µ–Ω—è", "–£ –º–µ–Ω—è –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è", "–ë–æ–ª—å—à–∏–µ –¥–µ–Ω—å–≥–∏ ‚Äì —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º—ã").

        ‚è∞ **–û—Ç–º–µ—á–∞–π—Ç–µ –º—ã—Å–ª–∏ –æ –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏–∏ –∏ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:** –ï—Å–ª–∏ —á–∞—Å—Ç–æ –ª–æ–≤–∏—Ç–µ —Å–µ–±—è –Ω–∞ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–Ω–∏–∏ –¥–µ–ª, –º—ã—Å–ª—è—Ö –æ –Ω–µ—Ö–≤–∞—Ç–∫–µ –Ω–∞–≤—ã–∫–æ–≤, –æ–ø—ã—Ç–∞, –≤—Ä–µ–º–µ–Ω–∏, –∏–ª–∏ —á—Ç–æ –≤–∞—à–∏ —É—Å–∏–ª–∏—è —Ç—â–µ—Ç–Ω—ã ‚Äì –∑–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ.

        üéØ **–ë—É–¥—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã:** –ü–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –º—ã—Å–ª—å —Ç–∞–∫, –∫–∞–∫ –æ–Ω–∞ –∑–≤—É—á–∏—Ç —É –≤–∞—Å –≤ –≥–æ–ª–æ–≤–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–∞—à–µ–π —Ä–∞–±–æ—Ç—ã –∏–ª–∏ –¥–µ–ª–∞.

        **–ü—Ä–∏–º–µ—Ä—ã –¥–ª—è —Å—Ç–∞—Ä—Ç–∞:**
        ‚Ä¢ "–Ø –±–æ—é—Å—å –Ω–∞—á–∞—Ç—å —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç"
        ‚Ä¢ "–£ –º–µ–Ω—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–ø—ã—Ç–∞ –¥–ª—è —ç—Ç–æ–π –¥–æ–ª–∂–Ω–æ—Å—Ç–∏"
        ‚Ä¢ "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –≤—Å–µ —Ä–∞–≤–Ω–æ —Å–∏–ª—å–Ω–µ–µ"
        ‚Ä¢ "–Ø –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞—Ä–∞–±–æ—Ç–∞—é –º–Ω–æ–≥–æ –¥–µ–Ω–µ–≥"
        ‚Ä¢ "–ï—Å–ª–∏ —è –æ—à–∏–±—É—Å—å, –≤—Å–µ —Ä—É—Ö–Ω–µ—Ç"

        –ì–ª–∞–≤–Ω–æ–µ ‚Äì –∑–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Ç–µ –º—ã—Å–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ—Ä–º–æ–∑—è—Ç –≤–∞—à –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç, –≤—ã–∑—ã–≤–∞—é—Ç –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –∏–ª–∏ –º–µ—à–∞—é—Ç –¥–æ—Å—Ç–∏–≥–∞—Ç—å –∂–µ–ª–∞–µ–º—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –¥–µ–ª–µ.
    next_step: request_ya_delo_input

  - id: request_ya_delo_input
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏ —Å–≤–æ–∏ –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã –≤ —Å—Ñ–µ—Ä–µ ¬´–Ø-–î–µ–ª–æ¬ª. –ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —á–µ—Å—Ç–µ–Ω —Å —Å–æ–±–æ–π."
      buttons:
        - text: "–ù–∞–ø–∏—Å–∞—Ç—å –ú—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã –Ø-–î–µ–ª–æ"
          callback_data: "ready_to_write"
    next_step: wait_for_ready_signal

  - id: wait_for_ready_signal
    type: input_button
    params:
      variable: "user_choice"
      timeout_seconds: 3600
    next_step: collect_ya_delo_response

  - id: collect_ya_delo_response
    type: input_text
    params:
      variable: "ya_delo_response"
      prompt: "–ù–∞–ø–∏—à–∏ —Å–≤–æ–∏ –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã ¬´–Ø-–î–µ–ª–æ¬ª:"
      timeout_seconds: 3600  # 1 —á–∞—Å –Ω–∞ –æ—Ç–≤–µ—Ç
    next_step: save_ya_delo_response

  - id: save_ya_delo_response
    type: action
    params:
      action_type: "update_context"
      updates:
        ya_delo_response: "{ya_delo_response}"
    next_step: save_to_database

  - id: save_to_database
    type: mongo_insert_document
    params:
      collection: "diagnostic_responses"
      document:
        user_id: "{user_id}"
        chat_id: "{chat_id}"
        stage: "ya_delo"
        response: "{ya_delo_response}"
        timestamp: "{current_timestamp}"
        session_id: "{session_id}"
    next_step: update_amocrm_contact

  - id: update_amocrm_contact
    type: amocrm_update_contact
    params:
      contact_id: "{amocrm_contact.contact_id}"
      custom_fields:
        DIAGNOSTIC_STAGE: "ya_delo_completed"
        YA_DELO_RESPONSE: "{ya_delo_response}"
        YA_DELO_COMPLETED_AT: "{current_timestamp}"
      output_var: "amocrm_update_result"
    next_step: add_ya_delo_note

  - id: add_ya_delo_note
    type: amocrm_add_note
    params:
      entity_type: "contacts"
      entity_id: "{amocrm_contact.contact_id}"
      note_type: "common"
      text: |
        ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ "–Ø-–î–µ–ª–æ" –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        
        üìÖ –î–∞—Ç–∞: {current_timestamp}
        üìù –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
        {ya_delo_response}
        
        –°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ "–Ø-–û—Ç–Ω–æ—à–µ–Ω–∏—è"
    next_step: update_stage_and_switch

  - id: update_stage_and_switch
    type: action
    params:
      action_type: "update_context"
      updates:
        current_stage: "diagnostic_ya_relations"
    next_step: switch_to_ya_relations

  - id: switch_to_ya_relations
    type: switch_scenario
    params:
      scenario_id: "mr_ontobot_diagnostic_ya_relations"
      preserve_context: true
    next_step: end

  - id: end
    type: end 