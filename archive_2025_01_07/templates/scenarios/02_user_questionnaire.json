{
  "scenario_id": "user_questionnaire",
  "version": "1.0",
  "description": "–û–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è, —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –∏ —Å–¥–µ–ª–∫–∏ –≤ AmoCRM",
  "author": "KittyCore Universal Agent Platform",
  
  "initial_context": {
    "current_question": 0,
    "questions": [
      {
        "field": "name",
        "question": "üë§ –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç? (–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è)",
        "validation": "required"
      },
      {
        "field": "phone", 
        "question": "üì± –£–∫–∞–∂–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:",
        "validation": "phone"
      },
      {
        "field": "email",
        "question": "üìß –£–∫–∞–∂–∏—Ç–µ –≤–∞—à email:",
        "validation": "email"
      },
      {
        "field": "position",
        "question": "üíº –ö–∞–∫–∞—è —É –≤–∞—Å –¥–æ–ª–∂–Ω–æ—Å—Ç—å?",
        "validation": "optional"
      },
      {
        "field": "company",
        "question": "üè¢ –í –∫–∞–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ?",
        "validation": "optional"
      }
    ]
  },
  
  "steps": [
    {
      "id": "start",
      "type": "start",
      "next_step": "load_user_data"
    },
    {
      "id": "load_user_data",
      "type": "mongo_find_one_document",
      "params": {
        "collection": "users",
        "filter": {"user_id": "{user_id}"},
        "output_var": "user_data"
      },
      "next_step": "ask_next_question"
    },
    {
      "id": "ask_next_question",
      "type": "branch",
      "params": {
        "conditions": [
          {
            "condition": "context.current_question < 5",
            "next_step_id": "send_question"
          }
        ],
        "default_next_step_id": "questionnaire_complete"
      }
    },
    {
      "id": "send_question",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "{questions[current_question].question}",
        "output_var": "question_sent"
      },
      "next_step": "wait_for_answer"
    },
    {
      "id": "wait_for_answer",
      "type": "input",
      "params": {
        "input_type": "telegram_message",
        "timeout": 300,
        "output_var": "user_answer"
      },
      "next_step": "validate_answer"
    },
    {
      "id": "validate_answer",
      "type": "action",
      "params": {
        "action": "validate_field",
        "field": "{questions[current_question].field}",
        "value": "{user_answer.text}",
        "validation": "{questions[current_question].validation}",
        "output_var": "validation_result"
      },
      "next_step": "check_validation"
    },
    {
      "id": "check_validation",
      "type": "branch",
      "params": {
        "conditions": [
          {
            "condition": "context.validation_result.valid == True",
            "next_step_id": "save_answer"
          }
        ],
        "default_next_step_id": "send_validation_error"
      }
    },
    {
      "id": "send_validation_error",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "‚ùå {validation_result.error}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:",
        "output_var": "error_sent"
      },
      "next_step": "wait_for_answer"
    },
    {
      "id": "save_answer",
      "type": "mongo_update_document",
      "params": {
        "collection": "users",
        "filter": {"user_id": "{user_id}"},
        "update": {
          "$set": {
            "profile.{questions[current_question].field}": "{user_answer.text}",
            "updated_at": "{current_datetime}"
          },
          "$push": {
            "dialog_context": {
              "timestamp": "{current_datetime}",
              "question": "{questions[current_question].question}",
              "answer": "{user_answer.text}",
              "field": "{questions[current_question].field}"
            }
          }
        },
        "output_var": "profile_updated"
      },
      "next_step": "increment_question"
    },
    {
      "id": "increment_question",
      "type": "action",
      "params": {
        "action": "increment",
        "variable": "current_question",
        "output_var": "next_question"
      },
      "next_step": "ask_next_question"
    },
    {
      "id": "questionnaire_complete",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "‚úÖ –û—Ç–ª–∏—á–Ω–æ! –î–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã.\n\nüîÑ –°–æ–∑–¥–∞—é –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –≤ —Å–∏—Å—Ç–µ–º–µ...",
        "output_var": "completion_sent"
      },
      "next_step": "load_final_profile"
    },
    {
      "id": "load_final_profile",
      "type": "mongo_find_one_document",
      "params": {
        "collection": "users",
        "filter": {"user_id": "{user_id}"},
        "output_var": "final_user_data"
      },
      "next_step": "create_amocrm_contact"
    },
    {
      "id": "create_amocrm_contact",
      "type": "amocrm_create_contact",
      "params": {
        "name": "{final_user_data.document.profile.name}",
        "phone": "{final_user_data.document.profile.phone}",
        "email": "{final_user_data.document.profile.email}",
        "custom_fields": {
          "–î–æ–ª–∂–Ω–æ—Å—Ç—å": "{final_user_data.document.profile.position}",
          "–ö–æ–º–ø–∞–Ω–∏—è": "{final_user_data.document.profile.company}",
          "Telegram Username": "{final_user_data.document.profile.tg_username}",
          "User ID": "{final_user_data.document.user_id}",
          "–≠—Ç–∞–ø –ø—Ä–æ–≥—Ä–∞–º–º—ã": "0",
          "–£—Ä–æ–≤–µ–Ω—å –ø–æ–¥–ø–∏—Å–∫–∏": "0"
        },
        "used_fields_map": true,
        "output_var": "amocrm_contact"
      },
      "next_step": "create_amocrm_lead"
    },
    {
      "id": "create_amocrm_lead",
      "type": "amocrm_create_lead",
      "params": {
        "name": "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ - {final_user_data.document.profile.name}",
        "price": 0,
        "contact_id": "{amocrm_contact.id}",
        "output_var": "amocrm_lead"
      },
      "next_step": "save_amocrm_ids"
    },
    {
      "id": "save_amocrm_ids",
      "type": "mongo_update_document",
      "params": {
        "collection": "users",
        "filter": {"user_id": "{user_id}"},
        "update": {
          "$set": {
            "amocrm_contact_id": "{amocrm_contact.id}",
            "amocrm_lead_id": "{amocrm_lead.id}",
            "stage": 1,
            "updated_at": "{current_datetime}"
          }
        },
        "output_var": "ids_saved"
      },
      "next_step": "questionnaire_success"
    },
    {
      "id": "questionnaire_success",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "üéâ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!\n\nüìã –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ...",
        "output_var": "success_sent"
      },
      "next_step": "start_diagnosis"
    },
    {
      "id": "start_diagnosis",
      "type": "switch_scenario",
      "params": {
        "scenario_id": "user_diagnosis",
        "preserve_context": true
      }
    },
    {
      "id": "end",
      "type": "end"
    }
  ],
  
  "requirements": {
    "plugins": ["MongoPlugin", "SimpleTelegramPlugin", "SimpleAmoCRMPlugin"],
    "context_variables": ["user_id", "chat_id"],
    "collections": ["users"]
  }
} 