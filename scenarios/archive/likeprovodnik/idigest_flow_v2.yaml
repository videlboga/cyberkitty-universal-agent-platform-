scenario_id: idigest_flow_v2
description: "i–î–∞–π–¥–∂–µ—Å—Ç - –Ω–æ–≤–æ—Å—Ç–∏ –ò–ò –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π v2.0"
version: "2.0"

initial_context:
  module_name: "i–î–∞–π–¥–∂–µ—Å—Ç"
  digest_type: "ai_news"

steps:
  - id: start
    type: start
    next_step: welcome_digest

  - id: welcome_digest
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üì∞ **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ i–î–∞–π–¥–∂–µ—Å—Ç!**

        –Ø –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –¥–ª—è —Ç–µ–±—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–Ω–¥—ã –≤ –º–∏—Ä–µ –ò–ò –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π.

        üî• **–ß—Ç–æ —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç:**
        ‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –ò–ò
        ‚Ä¢ –û–±–∑–æ—Ä —Ç—Ä–µ–Ω–¥–æ–≤ –Ω–µ–¥–µ–ª–∏
        ‚Ä¢ –ê–Ω–∞–ª–∏–∑ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
        ‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å–∞–π—Ç—ã

        üìÖ **–í—ã–±–µ—Ä–∏ —Ñ–æ—Ä–º–∞—Ç –¥–∞–π–¥–∂–µ—Å—Ç–∞:**
      parse_mode: HTML
    next_step: show_digest_options

  - id: show_digest_options
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: |
        üìã **–ö–∞–∫–æ–π –¥–∞–π–¥–∂–µ—Å—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å?**

        –í—ã–±–µ—Ä–∏ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â—É—é —Ç–µ–º—É:
      buttons:
        - - text: "ü§ñ –ù–æ–≤–æ—Å—Ç–∏ –ò–ò –∑–∞ –Ω–µ–¥–µ–ª—é"
            callback_data: "digest_ai_weekly"
        - - text: "üöÄ –°—Ç–∞—Ä—Ç–∞–ø—ã –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏"
            callback_data: "digest_startups"
        - - text: "üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–Ω–¥—ã"
            callback_data: "digest_tech_trends"
        - - text: "üß† –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è"
            callback_data: "digest_research"
        - - text: "üíº –ë–∏–∑–Ω–µ—Å –∏ –ò–ò"
            callback_data: "digest_business"
        - - text: "üéØ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç"
            callback_data: "digest_personal"
    next_step: wait_digest_type

  - id: wait_digest_type
    type: input
    params:
      variable: selected_digest
      validation: "required"
    next_step: process_digest_type

  - id: process_digest_type
    type: branch
    params:
      conditions:
        - condition: "context.get('selected_digest') == 'digest_personal'"
          next_step: ask_personal_interests
      default_next_step: generate_digest

  - id: ask_personal_interests
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üéØ **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç**

        –†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —Ç–µ–±—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç:
        ‚Ä¢ –ö–∞–∫–∏–µ –æ–±–ª–∞—Å—Ç–∏ –ò–ò?
        ‚Ä¢ –ö–∞–∫–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç—ã?
        ‚Ä¢ –ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏?

        –û–ø–∏—à–∏ —Å–≤–æ–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã, –∏ —è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –¥–∞–π–¥–∂–µ—Å—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–±—è! üìù
      parse_mode: HTML
    next_step: wait_interests

  - id: wait_interests
    type: input
    params:
      variable: personal_interests
      validation: "required"
    next_step: generate_personal_digest

  - id: generate_digest
    type: llm_query
    params:
      model: "gpt-4"
      system_prompt: |
        –¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º –∏ –ò–ò, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –¥–∞–π–¥–∂–µ—Å—Ç—ã.
        
        –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–π–¥–∂–µ—Å—Ç–∞:
        1. –ö—Ä–∞—Ç–∫–æ–µ –≤–≤–µ–¥–µ–Ω–∏–µ
        2. –¢–æ–ø-5 –≥–ª–∞–≤–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
        3. –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤
        4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã
        5. –ß—Ç–æ –æ–∂–∏–¥–∞—Ç—å –¥–∞–ª—å—à–µ
        
        –°—Ç–∏–ª—å:
        - –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
        - –î–æ—Å—Ç—É–ø–Ω—ã–π –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è
        - –° –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏–Ω—Å–∞–π—Ç–∞–º–∏
        - –ê–∫—Ç—É–∞–ª—å–Ω—ã–π –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π
      user_prompt: |
        –°–æ–∑–¥–∞–π –¥–∞–π–¥–∂–µ—Å—Ç –ø–æ —Ç–µ–º–µ: {selected_digest}
        
        –í–∫–ª—é—á–∏ —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏, —Ç—Ä–µ–Ω–¥—ã –∏ –∏–Ω—Å–∞–π—Ç—ã.
        –°–¥–µ–ª–∞–π –º–∞—Ç–µ—Ä–∏–∞–ª –ø–æ–ª–µ–∑–Ω—ã–º –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º.
      output_var: digest_content
    next_step: present_digest

  - id: generate_personal_digest
    type: llm_query
    params:
      model: "gpt-4"
      system_prompt: |
        –°–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
        1. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –≤–≤–µ–¥–µ–Ω–∏–µ
        2. –ù–æ–≤–æ—Å—Ç–∏ –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        3. –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã
        4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        5. –†–µ—Å—É—Ä—Å—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è
        
        –ê–¥–∞–ø—Ç–∏—Ä—É–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
      user_prompt: |
        –ò–Ω—Ç–µ—Ä–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {personal_interests}
        
        –°–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç –ò–ò-–Ω–æ–≤–æ—Å—Ç–µ–π –∏ —Ç—Ä–µ–Ω–¥–æ–≤.
      output_var: digest_content
    next_step: present_digest

  - id: present_digest
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üì∞ **–¢–≤–æ–π i–î–∞–π–¥–∂–µ—Å—Ç –≥–æ—Ç–æ–≤!**

        {digest_content}

        üìå **–ü–æ–ª–µ–∑–Ω–æ?**
      parse_mode: HTML
    next_step: ask_digest_action

  - id: ask_digest_action
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–ß—Ç–æ –¥–∞–ª—å—à–µ?"
      buttons:
        - - text: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–π–¥–∂–µ—Å—Ç"
            callback_data: "save_digest"
        - - text: "üîç –£–≥–ª—É–±–∏—Ç—å —Ç–µ–º—É"
            callback_data: "deep_dive"
        - - text: "üìÖ –î—Ä—É–≥–æ–π –¥–∞–π–¥–∂–µ—Å—Ç"
            callback_data: "another_digest"
        - - text: "üìß –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
            callback_data: "subscribe"
        - - text: "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
            callback_data: "main_menu"
    next_step: wait_digest_action

  - id: wait_digest_action
    type: input
    params:
      variable: digest_action
      validation: "required"
    next_step: process_digest_action

  - id: process_digest_action
    type: branch
    params:
      conditions:
        - condition: "context.get('digest_action') == 'save_digest'"
          next_step: save_digest
        - condition: "context.get('digest_action') == 'deep_dive'"
          next_step: deep_dive_topic
        - condition: "context.get('digest_action') == 'another_digest'"
          next_step: show_digest_options
        - condition: "context.get('digest_action') == 'subscribe'"
          next_step: setup_subscription
        - condition: "context.get('digest_action') == 'main_menu'"
          next_scenario: likeprovodnik_main_router_v2
      default_next_step: end

  - id: save_digest
    type: mongo_insert_document
    params:
      collection: user_digests
      document:
        user_id: "{user_id}"
        digest_type: "{selected_digest}"
        content: "{digest_content}"
        personal_interests: "{personal_interests}"
        created_at: "{current_timestamp}"
    next_step: confirm_save_digest

  - id: confirm_save_digest
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üíæ **–î–∞–π–¥–∂–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!**

        –¢—ã –º–æ–∂–µ—à—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–µ–º—É –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.

        –•–æ—á–µ—à—å –µ—â–µ –æ–¥–∏–Ω –¥–∞–π–¥–∂–µ—Å—Ç? üì∞
      parse_mode: HTML
    next_step: show_digest_options

  - id: deep_dive_topic
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üîç **–£–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑**

        –ö–∞–∫—É—é —Ç–µ–º—É –∏–∑ –¥–∞–π–¥–∂–µ—Å—Ç–∞ —Ö–æ—á–µ—à—å –∏–∑—É—á–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ?

        –ù–∞–ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã –∏–ª–∏ –æ–ø–∏—à–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç üëá
      parse_mode: HTML
    next_step: wait_deep_topic

  - id: wait_deep_topic
    type: input
    params:
      variable: deep_topic
      validation: "required"
    next_step: generate_deep_analysis

  - id: generate_deep_analysis
    type: llm_query
    params:
      model: "gpt-4"
      system_prompt: |
        –°–æ–∑–¥–∞–π —É–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–µ–º—ã.
        
        –í–∫–ª—é—á–∏:
        - –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
        - –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏
        - –í–ª–∏—è–Ω–∏–µ –Ω–∞ –∏–Ω–¥—É—Å—Ç—Ä–∏—é
        - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
        - –ü—Ä–æ–≥–Ω–æ–∑—ã —Ä–∞–∑–≤–∏—Ç–∏—è
      user_prompt: |
        –ò—Å—Ö–æ–¥–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç: {digest_content}
        –¢–µ–º–∞ –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–∏—è: {deep_topic}
        
        –°–æ–∑–¥–∞–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —ç—Ç–æ–π —Ç–µ–º—ã.
      output_var: deep_analysis
    next_step: present_deep_analysis

  - id: present_deep_analysis
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üî¨ **–£–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑:**

        {deep_analysis}
      parse_mode: HTML
    next_step: ask_digest_action

  - id: setup_subscription
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üìß **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ i–î–∞–π–¥–∂–µ—Å—Ç**

        –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö!

        –ê –ø–æ–∫–∞ —Ç—ã –º–æ–∂–µ—à—å:
        ‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –¥–∞–π–¥–∂–µ—Å—Ç—ã
        ‚Ä¢ –í–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∑–∞ –Ω–æ–≤—ã–º–∏ –æ–±–∑–æ—Ä–∞–º–∏
        ‚Ä¢ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã

        –°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å! üôè
      parse_mode: HTML
    next_step: show_digest_options

  - id: end
    type: end 