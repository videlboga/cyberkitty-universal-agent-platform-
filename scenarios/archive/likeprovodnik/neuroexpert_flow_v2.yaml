scenario_id: neuroexpert_flow_v2
description: "–ù–µ–π—Ä–æ–≠–∫—Å–ø–µ—Ä—Ç - –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á v2.0"
version: "2.0"

initial_context:
  module_name: "–ù–µ–π—Ä–æ–≠–∫—Å–ø–µ—Ä—Ç"
  analysis_mode: "step_by_step"

steps:
  - id: start
    type: start
    next_step: welcome_expert

  - id: welcome_expert
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üß† **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –∫ –ù–µ–π—Ä–æ–≠–∫—Å–ø–µ—Ä—Ç—É!**

        –Ø –ø–æ–º–æ–≥—É —Ä–∞–∑–ª–æ–∂–∏—Ç—å –ª—é–±—É—é —Å–ª–æ–∂–Ω—É—é –∑–∞–¥–∞—á—É –Ω–∞ –ø—Ä–æ—Å—Ç—ã–µ —à–∞–≥–∏ –∏ –Ω–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.

        üí° **–ú–æ–π –ø–æ–¥—Ö–æ–¥:**
        ‚Ä¢ –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω
        ‚Ä¢ –ü–æ—à–∞–≥–æ–≤–∞—è –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è
        ‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        ‚Ä¢ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è

        üéØ **–û–ø–∏—à–∏ —Å–≤–æ—é –∑–∞–¥–∞—á—É –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É:**
      parse_mode: HTML
    next_step: wait_problem

  - id: wait_problem
    type: input
    params:
      variable: user_problem
      validation: "required"
    next_step: analyze_problem

  - id: analyze_problem
    type: llm_query
    params:
      model: "gpt-4"
      system_prompt: |
        –¢—ã - —ç–∫—Å–ø–µ—Ä—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑–±–∏—Ä–∞–µ—Ç —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ—à–∞–≥–æ–≤–æ.
        
        –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–Ω–∞–ª–∏–∑–∞:
        1. –ü–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞)
        2. –í—ã—è–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
        3. –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –Ω–∞ –ø–æ–¥–∑–∞–¥–∞—á–∏
        4. –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —Ä–µ—à–µ–Ω–∏—è
        5. –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∏—Å–∫–∏ –∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
        6. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã
        7. –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞
        
        –ü—Ä–∏–Ω—Ü–∏–ø—ã:
        - –°–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥
        - –ü—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏–π
        - –£—á–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
        - –ò–∑–º–µ—Ä–∏–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      user_prompt: |
        –ó–∞–¥–∞—á–∞/–ø—Ä–æ–±–ª–µ–º–∞: {user_problem}
        
        –ü—Ä–æ–≤–µ–¥–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ.
      output_var: expert_analysis
    next_step: present_analysis

  - id: present_analysis
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üß† **–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑:**

        {expert_analysis}

        ü§î **–ß—Ç–æ —Ö–æ—á–µ—à—å —É—Ç–æ—á–Ω–∏—Ç—å?**
      parse_mode: HTML
    next_step: ask_clarification

  - id: ask_clarification
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:"
      buttons:
        - - text: "üîç –£–≥–ª—É–±–∏—Ç—å –∞–Ω–∞–ª–∏–∑"
            callback_data: "deep_analysis"
        - - text: "‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è"
            callback_data: "quick_actions"
        - - text: "üöß –†–∞–∑–æ–±—Ä–∞—Ç—å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è"
            callback_data: "obstacles"
        - - text: "üìä –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã"
            callback_data: "alternatives"
        - - text: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω"
            callback_data: "save_plan"
        - - text: "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
            callback_data: "main_menu"
    next_step: wait_clarification

  - id: wait_clarification
    type: input
    params:
      variable: clarification_type
      validation: "required"
    next_step: process_clarification

  - id: process_clarification
    type: branch
    params:
      conditions:
        - condition: "context.get('clarification_type') == 'deep_analysis'"
          next_step: deep_analysis
        - condition: "context.get('clarification_type') == 'quick_actions'"
          next_step: quick_actions
        - condition: "context.get('clarification_type') == 'obstacles'"
          next_step: analyze_obstacles
        - condition: "context.get('clarification_type') == 'alternatives'"
          next_step: find_alternatives
        - condition: "context.get('clarification_type') == 'save_plan'"
          next_step: save_analysis
        - condition: "context.get('clarification_type') == 'main_menu'"
          next_scenario: likeprovodnik_main_router_v2
      default_next_step: end

  - id: deep_analysis
    type: llm_query
    params:
      model: "gpt-4"
      system_prompt: |
        –£–≥–ª—É–±–∏ –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã. –†–∞—Å—Å–º–æ—Ç—Ä–∏:
        - –°–∫—Ä—ã—Ç—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        - –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è
        - –°–∏—Å—Ç–µ–º–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        - –î–µ—Ç–∞–ª—å–Ω—É—é –ø—Ä–æ—Ä–∞–±–æ—Ç–∫—É –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
      user_prompt: |
        –ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: {user_problem}
        –ë–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑: {expert_analysis}
        
        –ü—Ä–æ–≤–µ–¥–∏ —É–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π.
      output_var: deep_analysis_result
    next_step: present_deep_analysis

  - id: present_deep_analysis
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üî¨ **–£–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑:**

        {deep_analysis_result}
      parse_mode: HTML
    next_step: ask_clarification

  - id: quick_actions
    type: llm_query
    params:
      model: "gpt-4"
      system_prompt: |
        –í—ã–¥–µ–ª–∏ —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –∏ –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω—è—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.
        –§–æ–∫—É—Å –Ω–∞:
        - –î–µ–π—Å—Ç–≤–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞
        - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
        - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
        - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏
      user_prompt: |
        –ü—Ä–æ–±–ª–µ–º–∞: {user_problem}
        –ê–Ω–∞–ª–∏–∑: {expert_analysis}
        
        –ö–∞–∫–∏–µ 3-5 –¥–µ–π—Å—Ç–≤–∏–π –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω—è—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?
      output_var: quick_actions_result
    next_step: present_quick_actions

  - id: present_quick_actions
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        ‚ö° **–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:**

        {quick_actions_result}
      parse_mode: HTML
    next_step: ask_clarification

  - id: analyze_obstacles
    type: llm_query
    params:
      model: "gpt-4"
      system_prompt: |
        –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –∏ —Å–ø–æ—Å–æ–±—ã –∏—Ö –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏—è.
        –†–∞—Å—Å–º–æ—Ç—Ä–∏:
        - –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –±–∞—Ä—å–µ—Ä—ã
        - –í–Ω–µ—à–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
        - –†–µ—Å—É—Ä—Å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
        - –°–ø–æ—Å–æ–±—ã –æ–±—Ö–æ–¥–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
      user_prompt: |
        –ü—Ä–æ–±–ª–µ–º–∞: {user_problem}
        –ü–ª–∞–Ω: {expert_analysis}
        
        –ö–∞–∫–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –∏ –∫–∞–∫ –∏—Ö –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å?
      output_var: obstacles_analysis
    next_step: present_obstacles

  - id: present_obstacles
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üöß **–ê–Ω–∞–ª–∏–∑ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π:**

        {obstacles_analysis}
      parse_mode: HTML
    next_step: ask_clarification

  - id: find_alternatives
    type: llm_query
    params:
      model: "gpt-4"
      system_prompt: |
        –ü—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ —Ä–µ—à–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º—ã.
        –†–∞—Å—Å–º–æ—Ç—Ä–∏:
        - –ö–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ —Ä–∞–∑–Ω—ã–µ –º–µ—Ç–æ–¥—ã
        - –¢–≤–æ—Ä—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è
        - –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã
        - –ü–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã –∫–∞–∂–¥–æ–≥–æ
      user_prompt: |
        –ü—Ä–æ–±–ª–µ–º–∞: {user_problem}
        –û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–∞–Ω: {expert_analysis}
        
        –ö–∞–∫–∏–µ –µ—Å—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã —Ä–µ—à–µ–Ω–∏—è?
      output_var: alternatives_result
    next_step: present_alternatives

  - id: present_alternatives
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üîÑ **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

        {alternatives_result}
      parse_mode: HTML
    next_step: ask_clarification

  - id: save_analysis
    type: mongo_insert_document
    params:
      collection: user_expert_sessions
      document:
        user_id: "{user_id}"
        problem: "{user_problem}"
        analysis: "{expert_analysis}"
        deep_analysis: "{deep_analysis_result}"
        quick_actions: "{quick_actions_result}"
        obstacles: "{obstacles_analysis}"
        alternatives: "{alternatives_result}"
        created_at: "{current_timestamp}"
    next_step: confirm_save

  - id: confirm_save
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üíæ **–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!**

        –¢—ã –º–æ–∂–µ—à—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —ç—Ç–æ–º—É –ø–ª–∞–Ω—É –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.

        –ï—Å—Ç—å –µ—â–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞? üß†
      parse_mode: HTML
    next_step: welcome_expert

  - id: end
    type: end 