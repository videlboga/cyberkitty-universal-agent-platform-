{
  "scenario_id": "template_llm_chat",
  "name": "–®–∞–±–ª–æ–Ω: –£–º–Ω—ã–π —á–∞—Ç-–±–æ—Ç —Å LLM",
  "description": "–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —á–∞—Ç-–±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ LLM",
  "version": "1.0",
  "initial_context": {
    "bot_name": "AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç",
    "user_collection": "users",
    "conversation_collection": "conversations",
    "default_model": "deepseek/deepseek-chat",
    "max_tokens": 200,
    "temperature": 0.7,
    "system_prompt": "–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."
  },
  "steps": [
    {
      "id": "start",
      "type": "start",
      "params": {},
      "next_step": "get_user_id"
    },
    {
      "id": "get_user_id",
      "type": "input",
      "params": {
        "prompt": "–£–∫–∞–∂–∏—Ç–µ –≤–∞—à email –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—â–µ–Ω–∏—è:",
        "input_type": "text",
        "output_var": "user_email"
      },
      "next_step": "find_user"
    },
    {
      "id": "find_user",
      "type": "mongo_find_one",
      "params": {
        "collection": "{user_collection}",
        "filter": {
          "email": "{user_email}"
        },
        "output_var": "user_data"
      },
      "next_step": "check_user_found"
    },
    {
      "id": "check_user_found",
      "type": "branch",
      "params": {
        "conditions": [
          {
            "condition": "context.get('user_data') is not None",
            "next_step": "welcome_known_user"
          }
        ],
        "default_next_step": "welcome_new_user"
      }
    },
    {
      "id": "welcome_new_user",
      "type": "message",
      "params": {
        "text": "–ü—Ä–∏–≤–µ—Ç! –Ø {bot_name}. –Ø –Ω–µ –Ω–∞—à—ë–ª –≤–∞—Å –≤ —Å–≤–æ–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å. –ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"
      },
      "next_step": "get_user_message"
    },
    {
      "id": "welcome_known_user",
      "type": "message",
      "params": {
        "text": "–ü—Ä–∏–≤–µ—Ç, {user_data.name}! –†–∞–¥ —Å–Ω–æ–≤–∞ –≤–∞—Å –≤–∏–¥–µ—Ç—å. –ö–∞–∫ –¥–µ–ª–∞ –≤ –≥–æ—Ä–æ–¥–µ {user_data.city}? –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
      },
      "next_step": "get_user_message"
    },
    {
      "id": "get_user_message",
      "type": "input",
      "params": {
        "prompt": "–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ:",
        "input_type": "text",
        "output_var": "user_message"
      },
      "next_step": "prepare_llm_context"
    },
    {
      "id": "prepare_llm_context",
      "type": "branch",
      "params": {
        "conditions": [
          {
            "condition": "context.get('user_data') is not None",
            "next_step": "llm_with_user_context"
          }
        ],
        "default_next_step": "llm_without_context"
      }
    },
    {
      "id": "llm_with_user_context",
      "type": "llm_request",
      "params": {
        "prompt": "{system_prompt}\n\n–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:\n- –ò–º—è: {user_data.name}\n- Email: {user_data.email}\n- –ì–æ—Ä–æ–¥: {user_data.city}\n- –í–æ–∑—Ä–∞—Å—Ç: {user_data.age}\n- –¢–µ–ª–µ—Ñ–æ–Ω: {user_data.phone}\n\n–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_message}\n\n–û—Ç–≤–µ—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ, —É—á–∏—Ç—ã–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:",
        "model": "{default_model}",
        "max_tokens": "{max_tokens}",
        "temperature": "{temperature}",
        "output_var": "llm_response"
      },
      "next_step": "show_response"
    },
    {
      "id": "llm_without_context",
      "type": "llm_request",
      "params": {
        "prompt": "{system_prompt}\n\n–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_message}\n\n–û—Ç–≤–µ—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –ø–æ–ª–µ–∑–Ω–æ:",
        "model": "{default_model}",
        "max_tokens": "{max_tokens}",
        "temperature": "{temperature}",
        "output_var": "llm_response"
      },
      "next_step": "show_response"
    },
    {
      "id": "show_response",
      "type": "message",
      "params": {
        "text": "ü§ñ {bot_name}: {llm_response}"
      },
      "next_step": "save_conversation"
    },
    {
      "id": "save_conversation",
      "type": "mongo_insert_one",
      "params": {
        "collection": "{conversation_collection}",
        "document": {
          "user_email": "{user_email}",
          "user_name": "{user_data.name}",
          "user_message": "{user_message}",
          "bot_response": "{llm_response}",
          "model_used": "{default_model}",
          "timestamp": "{current_timestamp}",
          "session_id": "{session_id}"
        },
        "output_var": "conversation_saved"
      },
      "next_step": "ask_continue"
    },
    {
      "id": "ask_continue",
      "type": "input",
      "params": {
        "prompt": "–•–æ—Ç–∏—Ç–µ –ª–∏ –≤—ã –∑–∞–¥–∞—Ç—å –µ—â—ë –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å? (–¥–∞/–Ω–µ—Ç)",
        "input_type": "text",
        "output_var": "continue_choice"
      },
      "next_step": "check_continue"
    },
    {
      "id": "check_continue",
      "type": "branch",
      "params": {
        "conditions": [
          {
            "condition": "context.get('continue_choice', '').lower().strip() in ['–¥–∞', 'yes', 'y', '–¥', '1', '–∫–æ–Ω–µ—á–Ω–æ', '–ø—Ä–æ–¥–æ–ª–∂–∏–º']",
            "next_step": "get_user_message"
          }
        ],
        "default_next_step": "farewell"
      }
    },
    {
      "id": "farewell",
      "type": "branch",
      "params": {
        "conditions": [
          {
            "condition": "context.get('user_data') is not None",
            "next_step": "farewell_known_user"
          }
        ],
        "default_next_step": "farewell_new_user"
      }
    },
    {
      "id": "farewell_known_user",
      "type": "message",
      "params": {
        "text": "–î–æ —Å–≤–∏–¥–∞–Ω–∏—è, {user_data.name}! –ë—ã–ª–æ –ø—Ä–∏—è—Ç–Ω–æ —Å –≤–∞–º–∏ –ø–æ–æ–±—â–∞—Ç—å—Å—è. –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è!"
      },
      "next_step": "log_session_end"
    },
    {
      "id": "farewell_new_user",
      "type": "message",
      "params": {
        "text": "–î–æ —Å–≤–∏–¥–∞–Ω–∏—è! –ë—ã–ª–æ –ø—Ä–∏—è—Ç–Ω–æ —Å –≤–∞–º–∏ –ø–æ–æ–±—â–∞—Ç—å—Å—è. –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è!"
      },
      "next_step": "log_session_end"
    },
    {
      "id": "log_session_end",
      "type": "log",
      "params": {
        "message": "Chat session ended for user: {user_email}",
        "level": "INFO"
      },
      "next_step": "end"
    },
    {
      "id": "end",
      "type": "end",
      "params": {}
    }
  ]
} 