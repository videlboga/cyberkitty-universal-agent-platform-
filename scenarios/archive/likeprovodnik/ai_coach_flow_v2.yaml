scenario_id: ai_coach_flow_v2
description: "AI-–ö–æ—É—á - –º–æ—Ç–∏–≤–∞—Ü–∏—è, —Ü–µ–ª–∏ –∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏—è v2.0"
version: "2.0"

initial_context:
  module_name: "AI-–ö–æ—É—á"
  coaching_mode: "general"

steps:
  - id: start
    type: start
    next_step: welcome_coach

  - id: welcome_coach
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üßò **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –∫ AI-–ö–æ—É—á—É!**

        –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Å:
        ‚Ä¢ –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º —Ü–µ–ª–µ–π
        ‚Ä¢ –ú–æ—Ç–∏–≤–∞—Ü–∏–µ–π –∏ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
        ‚Ä¢ –†–µ—Ñ–ª–µ–∫—Å–∏–µ–π –∏ —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–æ–º
        ‚Ä¢ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ª–∏—á–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è

        üéØ **–ß—Ç–æ —Ç–µ–±—è –±–µ—Å–ø–æ–∫–æ–∏—Ç –∏–ª–∏ –Ω–∞–¥ —á–µ–º —Ö–æ—á–µ—à—å –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å?**
      parse_mode: HTML
    next_step: show_coaching_areas

  - id: show_coaching_areas
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: |
        üéØ **–í—ã–±–µ—Ä–∏ –æ–±–ª–∞—Å—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç—ã:**

        –ò–ª–∏ –æ–ø–∏—à–∏ —Å–≤–æ—é —Å–∏—Ç—É–∞—Ü–∏—é —Å–≤–æ–±–æ–¥–Ω–æ:
      buttons:
        - - text: "üéØ –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–ª–µ–π"
            callback_data: "area_goals"
        - - text: "üí™ –ú–æ—Ç–∏–≤–∞—Ü–∏—è –∏ —ç–Ω–µ—Ä–≥–∏—è"
            callback_data: "area_motivation"
        - - text: "üöß –ü—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π"
            callback_data: "area_obstacles"
        - - text: "üîÑ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
            callback_data: "area_changes"
        - - text: "ü§î –†–µ—Ñ–ª–µ–∫—Å–∏—è –∏ –∞–Ω–∞–ª–∏–∑"
            callback_data: "area_reflection"
        - - text: "üí¨ –°–≤–æ–±–æ–¥–Ω–∞—è –±–µ—Å–µ–¥–∞"
            callback_data: "area_free"
    next_step: wait_area

  - id: wait_area
    type: input
    params:
      variable: coaching_area
      validation: "required"
    next_step: process_area

  - id: process_area
    type: branch
    params:
      conditions:
        - condition: "context.get('coaching_area') == 'area_free'"
          next_step: ask_free_topic
      default_next_step: ask_specific_situation

  - id: ask_specific_situation
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üìù **–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Å–≤–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏:**

        –û–±–ª–∞—Å—Ç—å: {coaching_area}

        ‚Ä¢ –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?
        ‚Ä¢ –ß—Ç–æ —Ç–µ–±—è –±–µ—Å–ø–æ–∫–æ–∏—Ç?
        ‚Ä¢ –ö–∞–∫–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ö–æ—á–µ—à—å –¥–æ—Å—Ç–∏—á—å?

        –ß–µ–º –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π, —Ç–µ–º –ª—É—á—à–µ —è —Å–º–æ–≥—É –ø–æ–º–æ—á—å üí≠
      parse_mode: HTML
    next_step: wait_situation

  - id: ask_free_topic
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üí¨ **–†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —É —Ç–µ–±—è –Ω–∞ –¥—É—à–µ:**

        –Ø –≥–æ—Ç–æ–≤ –≤—ã—Å–ª—É—à–∞—Ç—å –∏ –ø–æ–º–æ—á—å —Å –ª—é–±–æ–π —Ç–µ–º–æ–π:
        ‚Ä¢ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã
        ‚Ä¢ –ö–∞—Ä—å–µ—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
        ‚Ä¢ –õ–∏—á–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è
        ‚Ä¢ –°–∞–º–æ—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

        –ì–æ–≤–æ—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ, —è –∑–¥–µ—Å—å —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å ü§ó
      parse_mode: HTML
    next_step: wait_situation

  - id: wait_situation
    type: input
    params:
      variable: user_situation
      validation: "required"
    next_step: analyze_situation

  - id: analyze_situation
    type: llm_query
    params:
      model: "gpt-4"
      system_prompt: |
        –¢—ã - –æ–ø—ã—Ç–Ω—ã–π –∫–æ—É—á –∏ –ø—Å–∏—Ö–æ–ª–æ–≥. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–∏—Ç—É–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–∞–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –æ—Ç–≤–µ—Ç.
        
        –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ—É—á–∏–Ω–≥–æ–≤–æ–π —Å–µ—Å—Å–∏–∏:
        1. –≠–º–ø–∞—Ç–∏—á–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏
        2. –í—ã—è–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤
        3. –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        4. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤ –∏ –∏–Ω—Å–∞–π—Ç–æ–≤
        5. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏
        
        –°—Ç–∏–ª—å:
        - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –∏ –±–µ–∑–æ—Ü–µ–Ω–æ—á–Ω—ã–π
        - –ó–∞–¥–∞–≤–∞–π –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
        - –ü–æ–º–æ–≥–∞–π –Ω–∞–π—Ç–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        - –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Ä–µ—Å—É—Ä—Å–∞—Ö –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö
      user_prompt: |
        –û–±–ª–∞—Å—Ç—å –∫–æ—É—á–∏–Ω–≥–∞: {coaching_area}
        –°–∏—Ç—É–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_situation}
        
        –ü—Ä–æ–≤–µ–¥–∏ –∫–æ—É—á–∏–Ω–≥–æ–≤—É—é —Å–µ—Å—Å–∏—é, –ø–æ–º–æ–≥–∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Å–∏—Ç—É–∞—Ü–∏–∏.
      output_var: coaching_response
    next_step: present_coaching

  - id: present_coaching
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üßò **–ö–æ—É—á–∏–Ω–≥–æ–≤–∞—è —Å–µ—Å—Å–∏—è:**

        {coaching_response}

        üí≠ **–ß—Ç–æ –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?**
      parse_mode: HTML
    next_step: ask_next_step

  - id: ask_next_step
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–ö–∞–∫ –ø—Ä–æ–¥–æ–ª–∂–∏–º?"
      buttons:
        - - text: "üîç –£–≥–ª—É–±–∏—Ç—å –∞–Ω–∞–ª–∏–∑"
            callback_data: "deeper_analysis"
        - - text: "üìã –°–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π"
            callback_data: "action_plan"
        - - text: "üí° –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Å–∞–π—Ç—ã"
            callback_data: "insights"
        - - text: "üéØ –ü–æ—Å—Ç–∞–≤–∏—Ç—å —Ü–µ–ª–∏"
            callback_data: "set_goals"
        - - text: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é"
            callback_data: "save_session"
        - - text: "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
            callback_data: "main_menu"
    next_step: wait_next_step

  - id: wait_next_step
    type: input
    params:
      variable: next_action
      validation: "required"
    next_step: process_next_step

  - id: process_next_step
    type: branch
    params:
      conditions:
        - condition: "context.get('next_action') == 'deeper_analysis'"
          next_step: deeper_analysis
        - condition: "context.get('next_action') == 'action_plan'"
          next_step: create_action_plan
        - condition: "context.get('next_action') == 'insights'"
          next_step: generate_insights
        - condition: "context.get('next_action') == 'set_goals'"
          next_step: goal_setting
        - condition: "context.get('next_action') == 'save_session'"
          next_step: save_session
        - condition: "context.get('next_action') == 'main_menu'"
          next_scenario: likeprovodnik_main_router_v2
      default_next_step: end

  - id: save_session
    type: mongo_insert_document
    params:
      collection: user_coaching_sessions
      document:
        user_id: "{user_id}"
        area: "{coaching_area}"
        situation: "{user_situation}"
        coaching_response: "{coaching_response}"
        created_at: "{current_timestamp}"
    next_step: confirm_save

  - id: confirm_save
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üíæ **–ö–æ—É—á–∏–Ω–≥–æ–≤–∞—è —Å–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!**

        –¢—ã –º–æ–∂–µ—à—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —ç—Ç–∏–º –∏–Ω—Å–∞–π—Ç–∞–º –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.

        –•–æ—á–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É? üå±
      parse_mode: HTML
    next_step: show_coaching_areas

  - id: end
    type: end 