{
  "scenario_id": "idigest_flow",
  "name": "i–î–∞–π–¥–∂–µ—Å—Ç",
  "description": "–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–Ω–¥—ã –≤ –æ–±–ª–∞—Å—Ç–∏ –ò–ò",
  "version": "1.0",
  
  "steps": [
    {
      "id": "start",
      "type": "start",
      "next_step": "load_user_context"
    },
    {
      "id": "load_user_context",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_mongo_find_data",
        "context_updates": {
          "collection": "users",
          "filter": {"user_id": "{user_id}"},
          "find_one": true,
          "output_var": "user_profile"
        }
      },
      "next_step": "log_request"
    },
    {
      "id": "log_request",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_log_message",
        "context_updates": {
          "message": "i–î–∞–π–¥–∂–µ—Å—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–ø—Ä–æ—Å–∏–ª –Ω–æ–≤–æ—Å—Ç–∏: {message_text}",
          "level": "INFO",
          "category": "idigest"
        }
      },
      "next_step": "detect_news_type"
    },
    {
      "id": "detect_news_type",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_llm_query",
        "context_updates": {
          "prompt": "–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ –Ω–æ–≤–æ—Å—Ç–µ–π:\n\n–ó–∞–ø—Ä–æ—Å: {message_text}\n\n–í–æ–∑–º–æ–∂–Ω—ã–µ —Ç–∏–ø—ã:\n1. daily_digest - –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç\n2. specific_topic - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ç–µ–º–∞\n3. trending - —Ç—Ä–µ–Ω–¥–æ–≤—ã–µ –Ω–æ–≤–æ—Å—Ç–∏\n4. research - –Ω–∞—É—á–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è\n5. tools - –Ω–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Å–µ—Ä–≤–∏—Å—ã\n\n–û—Ç–≤–µ—Ç—å –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º —Ç–∏–ø–æ–º –∑–∞–ø—Ä–æ—Å–∞.",
          "model": "meta-llama/llama-3.2-70b-instruct",
          "temperature": 0.1,
          "max_tokens": 50,
          "output_var": "news_type"
        }
      },
      "next_step": "search_relevant_news"
    },
    {
      "id": "search_relevant_news",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_rag_search",
        "context_updates": {
          "query": "{message_text} AI –Ω–æ–≤–æ—Å—Ç–∏ —Ç—Ä–µ–Ω–¥—ã",
          "collection": "ai_news",
          "limit": 5,
          "threshold": 0.5,
          "output_var": "relevant_news"
        }
      },
      "next_step": "check_user_interests"
    },
    {
      "id": "check_user_interests",
      "type": "conditional_branch",
      "params": {
        "condition": "exists({user_profile})",
        "if_true_step": "generate_personalized_digest",
        "if_false_step": "generate_generic_digest"
      }
    },
    {
      "id": "generate_personalized_digest",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_llm_query",
        "context_updates": {
          "prompt": "–°–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç –Ω–æ–≤–æ—Å—Ç–µ–π –ò–ò:\n\n–¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞: {news_type}\n–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {message_text}\n\n–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n- –û–ø—ã—Ç: {user_profile.experience_level}\n- –ò–Ω—Ç–µ—Ä–µ—Å—ã: {user_profile.interests}\n- –¶–µ–ª–∏: {user_profile.learning_goals}\n\n–ù–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏: {relevant_news}\n\n–°–æ–∑–¥–∞–π –¥–∞–π–¥–∂–µ—Å—Ç:\n1. –ê–¥–∞–ø—Ç–∏—Ä—É–π —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n2. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö\n3. –°–≤—è–∑—ã–≤–∞–π —Å –µ–≥–æ —Ü–µ–ª—è–º–∏ –æ–±—É—á–µ–Ω–∏—è\n4. –î–æ–±–∞–≤—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã\n5. –ü—Ä–µ–¥–ª–æ–∂–∏ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤–æ—Å—Ç–µ–π\n\n–§–æ—Ä–º–∞—Ç: HTML —Å —ç–º–æ–¥–∑–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç –¥–æ 1500 —Å–∏–º–≤–æ–ª–æ–≤.",
          "model": "meta-llama/llama-3.2-70b-instruct",
          "temperature": 0.4,
          "max_tokens": 2000,
          "output_var": "news_digest"
        }
      },
      "next_step": "save_digest"
    },
    {
      "id": "generate_generic_digest",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_llm_query",
        "context_updates": {
          "prompt": "–°–æ–∑–¥–∞–π –¥–∞–π–¥–∂–µ—Å—Ç –Ω–æ–≤–æ—Å—Ç–µ–π –ò–ò:\n\n–¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞: {news_type}\n–ó–∞–ø—Ä–æ—Å: {message_text}\n–ù–æ–≤–æ—Å—Ç–∏: {relevant_news}\n\n–°–æ–∑–¥–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç —Å:\n1. –ö—Ä–∞—Ç–∫–∏–º–∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –Ω–æ–≤–æ—Å—Ç–µ–π\n2. –ê–Ω–∞–ª–∏–∑–æ–º —Ç—Ä–µ–Ω–¥–æ–≤\n3. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ –≤—ã–≤–æ–¥–∞–º–∏\n4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è\n\n–§–æ—Ä–º–∞—Ç: HTML —Å —ç–º–æ–¥–∑–∏, –¥–æ 1500 —Å–∏–º–≤–æ–ª–æ–≤.",
          "model": "meta-llama/llama-3.2-70b-instruct",
          "temperature": 0.4,
          "max_tokens": 2000,
          "output_var": "news_digest"
        }
      },
      "next_step": "save_digest"
    },
    {
      "id": "save_digest",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_mongo_save_data",
        "context_updates": {
          "collection": "digest_history",
          "document": {
            "user_id": "{user_id}",
            "chat_id": "{chat_id}",
            "news_type": "{news_type}",
            "request": "{message_text}",
            "digest": "{news_digest}",
            "personalized": "exists({user_profile})",
            "created_at": "{current_time}"
          }
        }
      },
      "next_step": "send_digest"
    },
    {
      "id": "send_digest",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_message",
        "context_updates": {
          "text": "üì∞ <b>i–î–∞–π–¥–∂–µ—Å—Ç –¥–ª—è —Ç–µ–±—è:</b>\n\n{news_digest}",
          "parse_mode": "HTML"
        }
      },
      "next_step": "offer_actions"
    },
    {
      "id": "offer_actions",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_buttons",
        "context_updates": {
          "text": "üîç <b>–ß—Ç–æ –¥–∞–ª—å—à–µ?</b>",
          "buttons": [
            [{"text": "üìö –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Ç–µ–º–µ", "callback_data": "deep_dive"}],
            [{"text": "üîî –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥–∞–π–¥–∂–µ—Å—Ç", "callback_data": "subscribe_digest"}],
            [{"text": "üéØ –°–≤—è–∑–∞—Ç—å —Å –º–æ–∏–º–∏ —Ü–µ–ª—è–º–∏", "callback_data": "connect_goals"}],
            [{"text": "‚úÖ –°–ø–∞—Å–∏–±–æ", "callback_data": "digest_done"}]
          ]
        }
      },
      "next_step": "wait_action_choice"
    },
    {
      "id": "wait_action_choice",
      "type": "input",
      "params": {
        "input_type": "callback_query",
        "timeout_seconds": 120,
        "output_var": "action_choice"
      },
      "next_step": "handle_action"
    },
    {
      "id": "handle_action",
      "type": "conditional_branch",
      "params": {
        "condition": "{action_choice} == 'deep_dive'",
        "if_true_step": "deep_dive_analysis",
        "if_false_step": "check_subscribe"
      }
    },
    {
      "id": "check_subscribe",
      "type": "conditional_branch",
      "params": {
        "condition": "{action_choice} == 'subscribe_digest'",
        "if_true_step": "setup_subscription",
        "if_false_step": "check_goals"
      }
    },
    {
      "id": "check_goals",
      "type": "conditional_branch",
      "params": {
        "condition": "{action_choice} == 'connect_goals'",
        "if_true_step": "connect_with_goals",
        "if_false_step": "end"
      }
    },
    {
      "id": "deep_dive_analysis",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_llm_query",
        "context_updates": {
          "prompt": "–°–æ–∑–¥–∞–π —É–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–æ–≤–æ—Å—Ç–µ–π –∏–∑ –¥–∞–π–¥–∂–µ—Å—Ç–∞:\n\n–î–∞–π–¥–∂–µ—Å—Ç: {news_digest}\n–ò—Å—Ö–æ–¥–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏: {relevant_news}\n\n–î–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑:\n1. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏\n2. –í–ª–∏—è–Ω–∏–µ –Ω–∞ –∏–Ω–¥—É—Å—Ç—Ä–∏—é\n3. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è\n4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è\n5. –ü—Ä–æ–≥–Ω–æ–∑—ã —Ä–∞–∑–≤–∏—Ç–∏—è\n\n–§–æ—Ä–º–∞—Ç: HTML —Å —ç–º–æ–¥–∑–∏, –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑.",
          "model": "meta-llama/llama-3.2-70b-instruct",
          "temperature": 0.3,
          "max_tokens": 2000,
          "output_var": "deep_analysis"
        }
      },
      "next_step": "send_deep_analysis"
    },
    {
      "id": "send_deep_analysis",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_message",
        "context_updates": {
          "text": "üî¨ <b>–£–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑:</b>\n\n{deep_analysis}",
          "parse_mode": "HTML"
        }
      },
      "next_step": "end"
    },
    {
      "id": "setup_subscription",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_buttons",
        "context_updates": {
          "text": "üìÖ <b>–í—ã–±–µ—Ä–∏ —á–∞—Å—Ç–æ—Ç—É –¥–∞–π–¥–∂–µ—Å—Ç–∞:</b>",
          "buttons": [
            [{"text": "üì∞ –ï–∂–µ–¥–Ω–µ–≤–Ω–æ", "callback_data": "daily_digest"}],
            [{"text": "üìä –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ", "callback_data": "weekly_digest"}],
            [{"text": "üéØ –ü–æ —Ç—Ä–µ–Ω–¥–∞–º", "callback_data": "trending_digest"}],
            [{"text": "‚ùå –û—Ç–º–µ–Ω–∞", "callback_data": "cancel_subscription"}]
          ]
        }
      },
      "next_step": "wait_subscription_choice"
    },
    {
      "id": "wait_subscription_choice",
      "type": "input",
      "params": {
        "input_type": "callback_query",
        "timeout_seconds": 60,
        "output_var": "subscription_choice"
      },
      "next_step": "handle_subscription"
    },
    {
      "id": "handle_subscription",
      "type": "conditional_branch",
      "params": {
        "condition": "{subscription_choice} != 'cancel_subscription'",
        "if_true_step": "create_subscription",
        "if_false_step": "end"
      }
    },
    {
      "id": "create_subscription",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_scheduler_create_task",
        "context_updates": {
          "scenario_id": "automated_digest_delivery",
          "delay_minutes": "1440 if {subscription_choice} == 'daily_digest' else 10080",
          "task_context": {
            "subscription_type": "{subscription_choice}",
            "user_profile": "{user_profile}",
            "news_preferences": "{news_type}"
          }
        }
      },
      "next_step": "confirm_subscription"
    },
    {
      "id": "confirm_subscription",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_message",
        "context_updates": {
          "text": "‚úÖ <b>–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!</b>\n\n–¢–µ–ø–µ—Ä—å —Ç—ã –±—É–¥–µ—à—å –ø–æ–ª—É—á–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–π–¥–∂–µ—Å—Ç—ã –ò–ò-–Ω–æ–≤–æ—Å—Ç–µ–π.\n\n<i>–î–ª—è –æ—Ç–ø–∏—Å–∫–∏ –Ω–∞–ø–∏—à–∏ \"–æ—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç –¥–∞–π–¥–∂–µ—Å—Ç–∞\"</i>",
          "parse_mode": "HTML"
        }
      },
      "next_step": "end"
    },
    {
      "id": "connect_with_goals",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_llm_query",
        "context_updates": {
          "prompt": "–°–≤—è–∂–∏ –Ω–æ–≤–æ—Å—Ç–∏ –∏–∑ –¥–∞–π–¥–∂–µ—Å—Ç–∞ —Å —Ü–µ–ª—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n–î–∞–π–¥–∂–µ—Å—Ç: {news_digest}\n–¶–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_profile.learning_goals}\n–ò–Ω—Ç–µ—Ä–µ—Å—ã: {user_profile.interests}\n\n–ü–æ–∫–∞–∂–∏:\n1. –ö–∞–∫ –Ω–æ–≤–æ—Å—Ç–∏ —Å–≤—è–∑–∞–Ω—ã —Å –µ–≥–æ —Ü–µ–ª—è–º–∏\n2. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è\n3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏–∑—É—á–µ–Ω–∏—é\n4. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è\n\n–§–æ—Ä–º–∞—Ç: HTML —Å —ç–º–æ–¥–∑–∏, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.",
          "model": "meta-llama/llama-3.2-70b-instruct",
          "temperature": 0.4,
          "max_tokens": 1500,
          "output_var": "goal_connection"
        }
      },
      "next_step": "send_goal_connection"
    },
    {
      "id": "send_goal_connection",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_message",
        "context_updates": {
          "text": "üéØ <b>–°–≤—è–∑—å —Å —Ç–≤–æ–∏–º–∏ —Ü–µ–ª—è–º–∏:</b>\n\n{goal_connection}",
          "parse_mode": "HTML"
        }
      },
      "next_step": "end"
    },
    {
      "id": "end",
      "type": "end"
    }
  ]
} 