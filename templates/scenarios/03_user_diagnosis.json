{
  "scenario_id": "user_diagnosis",
  "version": "1.0",
  "description": "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: —Å–±–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ LLM",
  "author": "KittyCore Universal Agent Platform",
  
  "initial_context": {
    "current_question": 0,
    "diagnosis_questions": [
      {
        "id": "goals",
        "question": "üéØ –ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –¥–æ—Å—Ç–∏—á—å –≤ –±–ª–∏–∂–∞–π—à–∏–µ 6 –º–µ—Å—è—Ü–µ–≤?",
        "category": "goals"
      },
      {
        "id": "challenges",
        "question": "üöß –° –∫–∞–∫–∏–º–∏ –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ –≤—ã —Å—Ç–∞–ª–∫–∏–≤–∞–µ—Ç–µ—Å—å –≤ —Ä–∞–±–æ—Ç–µ/–±–∏–∑–Ω–µ—Å–µ?",
        "category": "challenges"
      },
      {
        "id": "experience",
        "question": "üìà –û–ø–∏—à–∏—Ç–µ –≤–∞—à –æ–ø—ã—Ç –≤ –æ–±–ª–∞—Å—Ç–∏, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–≤–∏–≤–∞—Ç—å:",
        "category": "experience"
      },
      {
        "id": "resources",
        "question": "‚è∞ –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –Ω–µ–¥–µ–ª—é –≤—ã –≥–æ—Ç–æ–≤—ã —É–¥–µ–ª—è—Ç—å —Ä–∞–∑–≤–∏—Ç–∏—é?",
        "category": "resources"
      },
      {
        "id": "expectations",
        "question": "üí° –ß—Ç–æ –≤—ã –æ–∂–∏–¥–∞–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ä–∞–∑–≤–∏—Ç–∏—è?",
        "category": "expectations"
      }
    ],
    "diagnosis_answers": {}
  },
  
  "steps": [
    {
      "id": "start",
      "type": "start",
      "next_step": "load_user_data"
    },
    {
      "id": "load_user_data",
      "type": "mongo_find_one_document",
      "params": {
        "collection": "users",
        "filter": {"user_id": "{user_id}"},
        "output_var": "user_data"
      },
      "next_step": "start_diagnosis_intro"
    },
    {
      "id": "start_diagnosis_intro",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "üîç <b>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</b>\n\n–¢–µ–ø–µ—Ä—å —è –∑–∞–¥–∞–º –≤–∞–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.\n\n–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É —Ä–∞–∑–≤–∏—Ç–∏—è –∏–º–µ–Ω–Ω–æ –¥–ª—è –≤–∞—Å.\n\nüìù –û—Ç–≤–µ—á–∞–π—Ç–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ - —á–µ–º –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —Ç–µ–º —Ç–æ—á–Ω–µ–µ –±—É–¥–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞.",
        "parse_mode": "HTML",
        "output_var": "intro_sent"
      },
      "next_step": "ask_diagnosis_question"
    },
    {
      "id": "ask_diagnosis_question",
      "type": "branch",
      "params": {
        "conditions": [
          {
            "condition": "context.current_question < 5",
            "next_step_id": "send_diagnosis_question"
          }
        ],
        "default_next_step_id": "diagnosis_complete"
      }
    },
    {
      "id": "send_diagnosis_question",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "<b>–í–æ–ø—Ä–æ—Å {current_question + 1} –∏–∑ {diagnosis_questions.length}</b>\n\n{diagnosis_questions[current_question].question}",
        "parse_mode": "HTML",
        "output_var": "question_sent"
      },
      "next_step": "wait_for_diagnosis_answer"
    },
    {
      "id": "wait_for_diagnosis_answer",
      "type": "input",
      "params": {
        "input_type": "telegram_message",
        "timeout": 600,
        "output_var": "diagnosis_answer"
      },
      "next_step": "save_diagnosis_answer"
    },
    {
      "id": "save_diagnosis_answer",
      "type": "action",
      "params": {
        "action": "save_to_object",
        "object": "diagnosis_answers",
        "key": "{diagnosis_questions[current_question].id}",
        "value": {
          "question": "{diagnosis_questions[current_question].question}",
          "answer": "{diagnosis_answer.text}",
          "category": "{diagnosis_questions[current_question].category}",
          "timestamp": "{current_datetime}"
        },
        "output_var": "answer_saved"
      },
      "next_step": "update_user_context"
    },
    {
      "id": "update_user_context",
      "type": "mongo_update_document",
      "params": {
        "collection": "users",
        "filter": {"user_id": "{user_id}"},
        "update": {
          "$push": {
            "dialog_context": {
              "timestamp": "{current_datetime}",
              "type": "diagnosis",
              "question": "{diagnosis_questions[current_question].question}",
              "answer": "{diagnosis_answer.text}",
              "category": "{diagnosis_questions[current_question].category}"
            }
          },
          "$set": {
            "updated_at": "{current_datetime}"
          }
        },
        "output_var": "context_updated"
      },
      "next_step": "increment_diagnosis_question"
    },
    {
      "id": "increment_diagnosis_question",
      "type": "action",
      "params": {
        "action": "increment",
        "variable": "current_question",
        "output_var": "next_question"
      },
      "next_step": "ask_diagnosis_question"
    },
    {
      "id": "diagnosis_complete",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ–π–¥–µ–Ω—ã.\n\nü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –∏ —Å–æ—Å—Ç–∞–≤–ª—è—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É...",
        "output_var": "analysis_start"
      },
      "next_step": "prepare_llm_prompt"
    },
    {
      "id": "prepare_llm_prompt",
      "type": "action",
      "params": {
        "action": "build_diagnosis_prompt",
        "user_profile": "{user_data.document.profile}",
        "diagnosis_answers": "{diagnosis_answers}",
        "output_var": "llm_prompt"
      },
      "next_step": "get_llm_diagnosis"
    },
    {
      "id": "get_llm_diagnosis",
      "type": "llm_query",
      "params": {
        "prompt": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–º—É —Ä–∞–∑–≤–∏—Ç–∏—é –∏ –±–∏–∑–Ω–µ—Å-–∫–æ—É—á–∏–Ω–≥—É. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–æ—Å—Ç–∞–≤—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É.\n\n–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n–ò–º—è: {user_data.document.profile.name}\n–î–æ–ª–∂–Ω–æ—Å—Ç—å: {user_data.document.profile.position}\n–ö–æ–º–ø–∞–Ω–∏—è: {user_data.document.profile.company}\n\n–û—Ç–≤–µ—Ç—ã –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã:\n{llm_prompt.formatted_answers}\n\n–°–æ—Å—Ç–∞–≤—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ:\n\nüéØ –ê–ù–ê–õ–ò–ó –¶–ï–õ–ï–ô:\n[–∞–Ω–∞–ª–∏–∑ —Ü–µ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]\n\nüöß –í–´–Ø–í–õ–ï–ù–ù–´–ï –í–´–ó–û–í–´:\n[–æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è]\n\nüìä –û–¶–ï–ù–ö–ê –¢–ï–ö–£–©–ï–ì–û –£–†–û–í–ù–Ø:\n[–æ—Ü–µ–Ω–∫–∞ –æ–ø—ã—Ç–∞ –∏ –Ω–∞–≤—ã–∫–æ–≤]\n\nüí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:\n[–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é]\n\nüéØ –ü–û–î–•–û–î–Ø–©–ò–ï –ü–†–û–ì–†–ê–ú–ú–´:\n[–∫–∞–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã/–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–æ–π–¥—É—Ç]\n\n‚≠ê –ü–†–ò–û–†–ò–¢–ï–¢–´:\n[—á—Ç–æ –≤–∞–∂–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å]\n\n–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–º. –û–±—ä–µ–º 300-500 —Å–ª–æ–≤.",
        "model": "gpt-4",
        "max_tokens": 1000,
        "output_var": "diagnosis_result"
      },
      "next_step": "send_diagnosis"
    },
    {
      "id": "send_diagnosis",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "üîç <b>–ü–ï–†–°–û–ù–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê</b>\n\n{diagnosis_result.response}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüöÄ –ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≤–∏—Ç–∏–µ? –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É –ø—Ä–æ–≥—Ä–∞–º–º—ã!",
        "parse_mode": "HTML",
        "output_var": "diagnosis_sent"
      },
      "next_step": "save_diagnosis"
    },
    {
      "id": "save_diagnosis",
      "type": "mongo_update_document",
      "params": {
        "collection": "users",
        "filter": {"user_id": "{user_id}"},
        "update": {
          "$set": {
            "diagnosis": {
              "result": "{diagnosis_result.response}",
              "answers": "{diagnosis_answers}",
              "created_at": "{current_datetime}"
            },
            "stage": 2,
            "updated_at": "{current_datetime}"
          }
        },
        "output_var": "diagnosis_saved"
      },
      "next_step": "update_amocrm_contact"
    },
    {
      "id": "update_amocrm_contact",
      "type": "amocrm_update_contact",
      "params": {
        "contact_id": "{user_data.document.amocrm_contact_id}",
        "custom_fields": {
          "–≠—Ç–∞–ø –ø—Ä–æ–≥—Ä–∞–º–º—ã": "2",
          "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞": "–ó–∞–≤–µ—Ä—à–µ–Ω–∞"
        },
        "used_fields_map": true,
        "output_var": "contact_updated"
      },
      "next_step": "start_subscription_check"
    },
    {
      "id": "start_subscription_check",
      "type": "switch_scenario",
      "params": {
        "scenario_id": "subscription_check",
        "preserve_context": true
      }
    },
    {
      "id": "end",
      "type": "end"
    }
  ],
  
  "requirements": {
    "plugins": ["MongoPlugin", "SimpleTelegramPlugin", "SimpleAmoCRMPlugin", "SimpleLLMPlugin"],
    "context_variables": ["user_id", "chat_id"],
    "collections": ["users"]
  }
} 