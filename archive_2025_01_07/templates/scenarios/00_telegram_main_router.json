{
  "scenario_id": "telegram_main_router",
  "version": "1.0",
  "description": "–ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä –¥–ª—è Telegram –±–æ—Ç–∞ - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π",
  "author": "KittyCore Universal Agent Platform",
  
  "initial_context": {
    "bot_commands": {
      "/start": "user_registration",
      "/help": "show_help",
      "/profile": "show_profile",
      "/status": "show_status",
      "/restart": "restart_program"
    }
  },
  
  "steps": [
    {
      "id": "start",
      "type": "start",
      "next_step": "extract_telegram_data"
    },
    {
      "id": "extract_telegram_data",
      "type": "action",
      "params": {
        "action": "extract_telegram_context",
        "telegram_update": "{telegram_update}",
        "output_var": "telegram_data"
      },
      "next_step": "check_message_type"
    },
    {
      "id": "check_message_type",
      "type": "branch",
      "params": {
        "condition": "{telegram_data.type}",
        "branches": {
          "message": "handle_message",
          "callback_query": "handle_callback",
          "inline_query": "handle_inline"
        },
        "default_step": "unknown_update_type"
      }
    },
    {
      "id": "handle_message",
      "type": "branch",
      "params": {
        "condition": "{telegram_data.text}",
        "branches": {
          "/start": "start_registration",
          "/help": "show_help",
          "/profile": "show_profile", 
          "/status": "show_status",
          "/restart": "restart_program"
        },
        "default_step": "handle_regular_message"
      }
    },
    {
      "id": "start_registration",
      "type": "switch_scenario",
      "params": {
        "scenario_id": "user_registration",
        "preserve_context": false,
        "context": {
          "user_id": "{telegram_data.user_id}",
          "chat_id": "{telegram_data.chat_id}",
          "username": "{telegram_data.username}",
          "first_name": "{telegram_data.first_name}",
          "last_name": "{telegram_data.last_name}",
          "current_datetime": "{current_datetime}"
        }
      }
    },
    {
      "id": "show_help",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{telegram_data.chat_id}",
        "text": "ü§ñ <b>–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É</b>\n\nüìã <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n/start - –ù–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é\n/profile - –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å\n/status - –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å\n/restart - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É\n/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\nüí¨ <b>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:</b>\n1. –ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /start\n2. –ü—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é\n3. –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏\n4. –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é –ø–æ–¥–ø–∏—Å–∫—É\n5. –°–ª–µ–¥—É–π—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º–µ —Ä–∞–∑–≤–∏—Ç–∏—è\n\nüìû <b>–ü–æ–¥–¥–µ—Ä–∂–∫–∞:</b>\n–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã - –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ!",
        "parse_mode": "HTML",
        "output_var": "help_sent"
      },
      "next_step": "end"
    },
    {
      "id": "show_profile",
      "type": "mongo_find_one_document",
      "params": {
        "collection": "users",
        "filter": {"user_id": "{telegram_data.user_id}"},
        "output_var": "user_profile"
      },
      "next_step": "check_profile_exists"
    },
    {
      "id": "check_profile_exists",
      "type": "branch",
      "params": {
        "condition": "{user_profile.found}",
        "true_step": "send_profile_info",
        "false_step": "profile_not_found"
      }
    },
    {
      "id": "send_profile_info",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{telegram_data.chat_id}",
        "text": "üë§ <b>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</b>\n\nüìù <b>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</b>\n‚Ä¢ –ò–º—è: {user_profile.document.profile.name}\n‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω: {user_profile.document.profile.phone}\n‚Ä¢ Email: {user_profile.document.profile.email}\n‚Ä¢ –î–æ–ª–∂–Ω–æ—Å—Ç—å: {user_profile.document.profile.position}\n‚Ä¢ –ö–æ–º–ø–∞–Ω–∏—è: {user_profile.document.profile.company}\n\nüìä <b>–°—Ç–∞—Ç—É—Å:</b>\n‚Ä¢ –≠—Ç–∞–ø –ø—Ä–æ–≥—Ä–∞–º–º—ã: {user_profile.document.stage}\n‚Ä¢ –£—Ä–æ–≤–µ–Ω—å –ø–æ–¥–ø–∏—Å–∫–∏: {user_profile.document.subscription_level}\n‚Ä¢ –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {user_profile.document.created_at}\n\nüîó <b>AmoCRM:</b>\n‚Ä¢ ID –∫–æ–Ω—Ç–∞–∫—Ç–∞: {user_profile.document.amocrm_contact_id}\n‚Ä¢ ID —Å–¥–µ–ª–∫–∏: {user_profile.document.amocrm_lead_id}",
        "parse_mode": "HTML",
        "output_var": "profile_sent"
      },
      "next_step": "end"
    },
    {
      "id": "profile_not_found",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{telegram_data.chat_id}",
        "text": "‚ùå –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\nüöÄ –ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏!",
        "output_var": "not_found_sent"
      },
      "next_step": "end"
    },
    {
      "id": "show_status",
      "type": "mongo_find_one_document",
      "params": {
        "collection": "users",
        "filter": {"user_id": "{telegram_data.user_id}"},
        "output_var": "user_status"
      },
      "next_step": "check_status_exists"
    },
    {
      "id": "check_status_exists",
      "type": "branch",
      "params": {
        "condition": "{user_status.found}",
        "true_step": "send_status_info",
        "false_step": "status_not_found"
      }
    },
    {
      "id": "send_status_info",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{telegram_data.chat_id}",
        "text": "üìä <b>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</b>\n\nüéØ <b>–≠—Ç–∞–ø –ø—Ä–æ–≥—Ä–∞–º–º—ã:</b> {user_status.document.stage}\n\nüìã <b>–û–ø–∏—Å–∞–Ω–∏–µ —ç—Ç–∞–ø–∞:</b>\n{stage_descriptions[user_status.document.stage]}\n\nüíé <b>–ü–æ–¥–ø–∏—Å–∫–∞:</b> {subscription_levels[user_status.document.subscription_level]}\n\n‚è∞ <b>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</b>\n{user_status.document.updated_at}\n\nüöÄ <b>–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:</b>\n{next_steps[user_status.document.stage]}",
        "parse_mode": "HTML",
        "output_var": "status_sent"
      },
      "next_step": "end"
    },
    {
      "id": "status_not_found",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{telegram_data.chat_id}",
        "text": "‚ùå –°—Ç–∞—Ç—É—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\nüöÄ –ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏!",
        "output_var": "status_not_found_sent"
      },
      "next_step": "end"
    },
    {
      "id": "restart_program",
      "type": "telegram_send_buttons",
      "params": {
        "chat_id": "{telegram_data.chat_id}",
        "text": "üîÑ <b>–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã</b>\n\n‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É?\n\n–≠—Ç–æ –≤–µ—Ä–Ω–µ—Ç –≤–∞—Å –∫ –Ω–∞—á–∞–ª—É, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å.",
        "parse_mode": "HTML",
        "buttons": [
          [
            {"text": "‚úÖ –î–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å", "callback_data": "confirm_restart"},
            {"text": "‚ùå –û—Ç–º–µ–Ω–∞", "callback_data": "cancel_restart"}
          ]
        ],
        "output_var": "restart_confirmation"
      },
      "next_step": "end"
    },
    {
      "id": "handle_regular_message",
      "type": "mongo_find_one_document",
      "params": {
        "collection": "users",
        "filter": {"user_id": "{telegram_data.user_id}"},
        "output_var": "current_user"
      },
      "next_step": "check_user_exists_for_message"
    },
    {
      "id": "check_user_exists_for_message",
      "type": "branch",
      "params": {
        "condition": "{current_user.found}",
        "true_step": "route_by_user_stage",
        "false_step": "suggest_registration"
      }
    },
    {
      "id": "route_by_user_stage",
      "type": "branch",
      "params": {
        "condition": "{current_user.document.stage}",
        "branches": {
          "0": "continue_questionnaire",
          "1": "continue_diagnosis",
          "2": "continue_subscription_check"
        },
        "default_step": "handle_general_message"
      }
    },
    {
      "id": "continue_questionnaire",
      "type": "switch_scenario",
      "params": {
        "scenario_id": "user_questionnaire",
        "preserve_context": true,
        "context": {
          "user_id": "{telegram_data.user_id}",
          "chat_id": "{telegram_data.chat_id}",
          "user_message": "{telegram_data.text}"
        }
      }
    },
    {
      "id": "continue_diagnosis",
      "type": "switch_scenario",
      "params": {
        "scenario_id": "user_diagnosis",
        "preserve_context": true,
        "context": {
          "user_id": "{telegram_data.user_id}",
          "chat_id": "{telegram_data.chat_id}",
          "user_message": "{telegram_data.text}"
        }
      }
    },
    {
      "id": "continue_subscription_check",
      "type": "switch_scenario",
      "params": {
        "scenario_id": "subscription_check",
        "preserve_context": true,
        "context": {
          "user_id": "{telegram_data.user_id}",
          "chat_id": "{telegram_data.chat_id}",
          "user_message": "{telegram_data.text}"
        }
      }
    },
    {
      "id": "handle_general_message",
      "type": "llm_chat",
      "params": {
        "system_prompt": "–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è. –û—Ç–≤–µ—á–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –Ω–∞–ø—Ä–∞–≤–ª—è–π –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—é –ø—Ä–æ–≥—Ä–∞–º–º—ã.",
        "user_message": "{telegram_data.text}",
        "model": "gpt-4",
        "max_tokens": 200,
        "output_var": "general_response"
      },
      "next_step": "send_general_response"
    },
    {
      "id": "send_general_response",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{telegram_data.chat_id}",
        "text": "{general_response.response}\n\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥",
        "output_var": "general_sent"
      },
      "next_step": "end"
    },
    {
      "id": "suggest_registration",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{telegram_data.chat_id}",
        "text": "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –≤–∏–∂—É, –≤—ã –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.\n\nüöÄ –ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ä–∞–∑–≤–∏—Ç–∏—è!",
        "output_var": "suggest_sent"
      },
      "next_step": "end"
    },
    {
      "id": "handle_callback",
      "type": "action",
      "params": {
        "action": "route_callback",
        "callback_data": "{telegram_data.callback_data}",
        "user_id": "{telegram_data.user_id}",
        "chat_id": "{telegram_data.chat_id}",
        "output_var": "callback_route"
      },
      "next_step": "execute_callback_scenario"
    },
    {
      "id": "execute_callback_scenario",
      "type": "switch_scenario",
      "params": {
        "scenario_id": "{callback_route.scenario_id}",
        "preserve_context": true,
        "context": {
          "user_id": "{telegram_data.user_id}",
          "chat_id": "{telegram_data.chat_id}",
          "callback_data": "{telegram_data.callback_data}",
          "callback_context": "{callback_route.context}"
        }
      }
    },
    {
      "id": "handle_inline",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{telegram_data.chat_id}",
        "text": "üîç Inline –∑–∞–ø—Ä–æ—Å—ã –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è.",
        "output_var": "inline_sent"
      },
      "next_step": "end"
    },
    {
      "id": "unknown_update_type",
      "type": "log_message",
      "params": {
        "message": "Unknown Telegram update type: {telegram_data.type}",
        "level": "warning"
      },
      "next_step": "end"
    },
    {
      "id": "end",
      "type": "end"
    }
  ],
  
  "requirements": {
    "plugins": ["MongoPlugin", "SimpleTelegramPlugin", "SimpleLLMPlugin"],
    "context_variables": ["telegram_update"],
    "collections": ["users"]
  }
} 