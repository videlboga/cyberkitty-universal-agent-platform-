{
  "scenario_id": "subscription_check",
  "version": "1.0",
  "description": "–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏",
  "author": "KittyCore Universal Agent Platform",
  
  "initial_context": {
    "required_subscription_level": 1,
    "subscription_levels": {
      "0": "–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è",
      "1": "–ë–∞–∑–æ–≤–∞—è", 
      "2": "–ü—Ä–µ–º–∏—É–º",
      "3": "VIP"
    }
  },
  
  "steps": [
    {
      "id": "start",
      "type": "start",
      "next_step": "load_user_data"
    },
    {
      "id": "load_user_data",
      "type": "mongo_find_one_document",
      "params": {
        "collection": "users",
        "filter": {"user_id": "{user_id}"},
        "output_var": "user_data"
      },
      "next_step": "check_subscription_level"
    },
    {
      "id": "check_subscription_level",
      "type": "branch",
      "params": {
        "conditions": [
          {
            "condition": "context.user_data.document.subscription_level >= context.required_subscription_level",
            "next_step_id": "subscription_sufficient"
          }
        ],
        "default_next_step_id": "subscription_insufficient"
      }
    },
    {
      "id": "subscription_sufficient",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "‚úÖ –û—Ç–ª–∏—á–Ω–æ! –£ –≤–∞—Å –ø–æ–¥–ø–∏—Å–∫–∞ —É—Ä–æ–≤–Ω—è <b>{subscription_levels[user_data.document.subscription_level]}</b>\n\nüöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É –ø—Ä–æ–≥—Ä–∞–º–º—ã!",
        "parse_mode": "HTML",
        "output_var": "sufficient_sent"
      },
      "next_step": "proceed_to_next_stage"
    },
    {
      "id": "subscription_insufficient",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "üìä –í–∞—à —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: <b>{subscription_levels[user_data.document.subscription_level]}</b>\n\nüîí –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ —É—Ä–æ–≤–Ω—è <b>{subscription_levels[required_subscription_level]}</b>\n\nüí¨ –î–∞–≤–∞–π—Ç–µ –æ–±—Å—É–¥–∏–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏!",
        "parse_mode": "HTML",
        "output_var": "insufficient_sent"
      },
      "next_step": "start_subscription_dialog"
    },
    {
      "id": "start_subscription_dialog",
      "type": "llm_chat",
      "params": {
        "system_prompt": "–¢—ã –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –º—è–≥–∫–æ –∏ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥–ø–∏—Å–∫—É.\n\n–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:\n- –ò–º—è: {user_data.document.profile.name}\n- –î–æ–ª–∂–Ω–æ—Å—Ç—å: {user_data.document.profile.position}\n- –ö–æ–º–ø–∞–Ω–∏—è: {user_data.document.profile.company}\n- –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–ø–∏—Å–∫–∏: {subscription_levels[user_data.document.subscription_level]}\n- –¢—Ä–µ–±—É–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å: {subscription_levels[required_subscription_level]}\n\n–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n{user_data.document.diagnosis.result}\n\n–¢–≤–æ–π —Å—Ç–∏–ª—å:\n- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π\n- –§–æ–∫—É—Å –Ω–∞ —Ü–µ–Ω–Ω–æ—Å—Ç—è—Ö –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö\n- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥\n- –ù–µ –Ω–∞–≤—è–∑—á–∏–≤—ã–π, –Ω–æ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–π\n\n–ü—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥–ø–∏—Å–∫—É, –æ–±—ä—è—Å–Ω–∏–≤ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ —Ü–µ–Ω–Ω–æ—Å—Ç—å. –°–ø—Ä–æ—Å–∏, –µ—Å—Ç—å –ª–∏ —É –Ω–µ–≥–æ –≤–æ–ø—Ä–æ—Å—ã.",
        "user_message": "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö –ø–æ–¥–ø–∏—Å–∫–∏",
        "model": "gpt-4",
        "max_tokens": 500,
        "output_var": "subscription_offer"
      },
      "next_step": "send_subscription_offer"
    },
    {
      "id": "send_subscription_offer",
      "type": "telegram_send_buttons",
      "params": {
        "chat_id": "{chat_id}",
        "text": "{subscription_offer.response}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüí≥ <b>–í–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏:</b>",
        "parse_mode": "HTML",
        "buttons": [
          [{"text": "üíé –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ - 2990‚ÇΩ/–º–µ—Å", "callback_data": "subscribe_basic"}],
          [{"text": "üåü –ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞ - 4990‚ÇΩ/–º–µ—Å", "callback_data": "subscribe_premium"}],
          [{"text": "üëë VIP –ø–æ–¥–ø–∏—Å–∫–∞ - 9990‚ÇΩ/–º–µ—Å", "callback_data": "subscribe_vip"}],
          [{"text": "‚ùì –£ –º–µ–Ω—è –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã", "callback_data": "subscription_questions"}],
          [{"text": "‚è∞ –ü–æ–¥—É–º–∞—é –ø–æ–∑–∂–µ", "callback_data": "subscription_later"}]
        ],
        "output_var": "offer_sent"
      },
      "next_step": "wait_for_subscription_choice"
    },
    {
      "id": "wait_for_subscription_choice",
      "type": "input",
      "params": {
        "input_type": "telegram_callback",
        "timeout": 1800,
        "output_var": "subscription_choice"
      },
      "next_step": "handle_subscription_choice"
    },
    {
      "id": "handle_subscription_choice",
      "type": "branch",
      "params": {
        "conditions": [
          {
            "condition": "context.subscription_choice.data == 'subscribe_basic'",
            "next_step_id": "process_basic_subscription"
          },
          {
            "condition": "context.subscription_choice.data == 'subscribe_premium'",
            "next_step_id": "process_premium_subscription"
          },
          {
            "condition": "context.subscription_choice.data == 'subscribe_vip'",
            "next_step_id": "process_vip_subscription"
          },
          {
            "condition": "context.subscription_choice.data == 'subscription_questions'",
            "next_step_id": "handle_questions"
          },
          {
            "condition": "context.subscription_choice.data == 'subscription_later'",
            "next_step_id": "handle_later"
          }
        ],
        "default_next_step_id": "unknown_choice"
      }
    },
    {
      "id": "process_basic_subscription",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "üíé <b>–ë–∞–∑–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –≤—ã–±—Ä–∞–Ω–∞!</b>\n\nüìã –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ:\n‚Ä¢ –î–æ—Å—Ç—É–ø –∫ –æ—Å–Ω–æ–≤–Ω—ã–º –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º\n‚Ä¢ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –≤–µ–±–∏–Ω–∞—Ä—ã\n‚Ä¢ –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏\n‚Ä¢ –ë–∞–∑–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã\n\nüí≥ –°—Ç–æ–∏–º–æ—Å—Ç—å: 2990‚ÇΩ/–º–µ—Å—è—Ü\n\nüîó –°—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã: [PAYMENT_LINK_BASIC]",
        "parse_mode": "HTML",
        "output_var": "basic_sent"
      },
      "next_step": "save_subscription_intent"
    },
    {
      "id": "process_premium_subscription",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "üåü <b>–ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞ –≤—ã–±—Ä–∞–Ω–∞!</b>\n\nüìã –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ:\n‚Ä¢ –í—Å–µ –∏–∑ –ë–∞–∑–æ–≤–æ–π\n‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏\n‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã\n‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞\n‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã\n\nüí≥ –°—Ç–æ–∏–º–æ—Å—Ç—å: 4990‚ÇΩ/–º–µ—Å—è—Ü\n\nüîó –°—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã: [PAYMENT_LINK_PREMIUM]",
        "parse_mode": "HTML",
        "output_var": "premium_sent"
      },
      "next_step": "save_subscription_intent"
    },
    {
      "id": "process_vip_subscription",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "üëë <b>VIP –ø–æ–¥–ø–∏—Å–∫–∞ –≤—ã–±—Ä–∞–Ω–∞!</b>\n\nüìã –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ:\n‚Ä¢ –í—Å–µ –∏–∑ –ü—Ä–µ–º–∏—É–º\n‚Ä¢ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ\n‚Ä¢ –ó–∞–∫—Ä—ã—Ç—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è\n‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä\n‚Ä¢ –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã\n‚Ä¢ –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏\n\nüí≥ –°—Ç–æ–∏–º–æ—Å—Ç—å: 9990‚ÇΩ/–º–µ—Å—è—Ü\n\nüîó –°—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã: [PAYMENT_LINK_VIP]",
        "parse_mode": "HTML",
        "output_var": "vip_sent"
      },
      "next_step": "save_subscription_intent"
    },
    {
      "id": "handle_questions",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "‚ùì <b>–ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã?</b>\n\n–ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ–¥–ø–∏—Å–∫–µ, –∏ —è –æ—Ç–≤–µ—á—É –Ω–∞ –Ω–∏—Ö!\n\nüí¨ –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å:",
        "parse_mode": "HTML",
        "output_var": "questions_sent"
      },
      "next_step": "start_questions_dialog"
    },
    {
      "id": "start_questions_dialog",
      "type": "switch_scenario",
      "params": {
        "scenario_id": "subscription_questions_dialog",
        "preserve_context": true
      }
    },
    {
      "id": "handle_later",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "‚è∞ <b>–•–æ—Ä–æ—à–æ, –ø–æ–¥—É–º–∞–π—Ç–µ!</b>\n\n–í—ã –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.\n\nüìû –ï—Å–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –≤–æ–ø—Ä–æ—Å—ã - –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ!\n\nüîî –ù–∞–ø–æ–º–Ω—é –≤–∞–º —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞.",
        "parse_mode": "HTML",
        "output_var": "later_sent"
      },
      "next_step": "schedule_reminder"
    },
    {
      "id": "save_subscription_intent",
      "type": "mongo_update_document",
      "params": {
        "collection": "users",
        "filter": {"user_id": "{user_id}"},
        "update": {
          "$set": {
            "subscription_intent": {
              "level": "{subscription_choice.data}",
              "timestamp": "{current_datetime}",
              "status": "pending_payment"
            },
            "updated_at": "{current_datetime}"
          }
        },
        "output_var": "intent_saved"
      },
      "next_step": "update_amocrm_lead"
    },
    {
      "id": "update_amocrm_lead",
      "type": "amocrm_update_contact",
      "params": {
        "contact_id": "{user_data.document.amocrm_contact_id}",
        "custom_fields": {
          "–≠—Ç–∞–ø –ø—Ä–æ–≥—Ä–∞–º–º—ã": "2",
          "–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏": "–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã",
          "–í—ã–±—Ä–∞–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞": "{subscription_choice.data}"
        },
        "used_fields_map": true,
        "output_var": "amocrm_updated"
      },
      "next_step": "end"
    },
    {
      "id": "schedule_reminder",
      "type": "scheduler_create_task",
      "params": {
        "task_id": "subscription_reminder_{user_id}",
        "scenario_id": "subscription_reminder",
        "schedule_time": "{current_datetime + 24h}",
        "context": {
          "user_id": "{user_id}",
          "chat_id": "{chat_id}",
          "reminder_type": "subscription"
        },
        "output_var": "reminder_scheduled"
      },
      "next_step": "end"
    },
    {
      "id": "proceed_to_next_stage",
      "type": "switch_scenario",
      "params": {
        "scenario_id": "program_stage_3",
        "preserve_context": true
      }
    },
    {
      "id": "unknown_choice",
      "type": "telegram_send_message",
      "params": {
        "chat_id": "{chat_id}",
        "text": "ü§î –ù–µ –ø–æ–Ω—è–ª –≤–∞—à –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:",
        "output_var": "unknown_sent"
      },
      "next_step": "send_subscription_offer"
    },
    {
      "id": "end",
      "type": "end"
    }
  ],
  
  "requirements": {
    "plugins": ["MongoPlugin", "SimpleTelegramPlugin", "SimpleAmoCRMPlugin", "SimpleLLMPlugin", "SimpleSchedulerPlugin"],
    "context_variables": ["user_id", "chat_id"],
    "collections": ["users"]
  }
} 