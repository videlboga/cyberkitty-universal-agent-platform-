scenario_id: "mr_ontobot_diagnostic_ya_ya"
name: "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ø-–Ø"
description: "–ü–µ—Ä–≤—ã–π —ç—Ç–∞–ø –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤ - —Å—Ñ–µ—Ä–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∫ —Å–µ–±–µ"

initial_context:
  current_diagnostic_stage: "ya_ya"
  ya_ya_response: null
  examples_viewed: false

steps:
  - id: start
    type: start
    next_step: send_ya_ya_video

  - id: send_ya_ya_video
    type: channel_action
    params:
      action: forward_message
      chat_id: "{chat_id}"
      from_chat_id: "-1002614708769"
      message_id: 3  # ID –≤–∏–¥–µ–æ "–ó–∞–¥–∞–Ω–∏–µ –Ø-–Ø" - –≤—Ç–æ—Ä–æ–µ –≤–∏–¥–µ–æ –≤ –∫–∞–Ω–∞–ª–µ
    next_step: show_ya_ya_options

  - id: show_ya_ya_options
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–ü–æ—Å–º–æ—Ç—Ä–∏ –≤–∏–¥–µ–æ –∏ –≤—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞–Ω–∏–µ"
      buttons:
        - text: "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–º–µ—Ä—ã –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤"
          callback_data: "view_ya_ya_examples"
        - text: "–ù–∞–ø–∏—Å–∞—Ç—å –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã ¬´–Ø-–Ø¬ª"
          callback_data: "write_ya_ya_viruses"
    next_step: wait_for_choice

  - id: wait_for_choice
    type: input_button
    params:
      variable: "user_choice"
      timeout_seconds: 3600
    next_step: process_choice

  - id: process_choice
    type: branch
    params:
      conditions:
        - condition: "{callback_data} == 'view_ya_ya_examples'"
          next_step: show_examples
        - condition: "{callback_data} == 'write_ya_ya_viruses'"
          next_step: provide_instructions
      default_next_step: show_examples

  - id: show_examples
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: "üìä –ü—Ä–∏–º–µ—Ä—ã –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤ ¬´–Ø-–Ø¬ª"
      # TODO: –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∏ –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞
    next_step: update_examples_viewed

  - id: update_examples_viewed
    type: action
    params:
      action_type: "update_context"
      updates:
        examples_viewed: true
    next_step: offer_writing_after_examples

  - id: offer_writing_after_examples
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—à—å –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ –Ω–∞–ø–∏—Å–∞–Ω–∏—é —Å–≤–æ–∏—Ö –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤"
      buttons:
        - text: "–ù–∞–ø–∏—Å–∞—Ç—å –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã ¬´–Ø-–Ø¬ª"
          callback_data: "write_ya_ya_viruses"
    next_step: wait_for_writing_choice

  - id: wait_for_writing_choice
    type: input_button
    params:
      variable: "user_choice"
      timeout_seconds: 3600
    next_step: provide_instructions

  - id: provide_instructions
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        –ö–∞–∫ –ø–∏—Å–∞—Ç—å –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã "–Ø –∏ –Ø":

        üéØ **–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ —Å–µ–±–µ:** –ü–æ–¥—É–º–∞–π—Ç–µ –æ —Å–≤–æ–µ–º –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ –∫ —Å–µ–±–µ, –æ —Å–≤–æ–∏—Ö –∫–∞—á–µ—Å—Ç–≤–∞—Ö, —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è—Ö, –≤–Ω–µ—à–Ω–æ—Å—Ç–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ, —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –∫–∞–∫ –ª–∏—á–Ω–æ—Å—Ç–∏.

        üîç **–õ–æ–≤–∏—Ç–µ —Å–∞–º–æ–∫—Ä–∏—Ç–∏–∫—É:** –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –ª—é–±—ã–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ, –æ—Å—É–∂–¥–∞—é—â–∏–µ –∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏–µ –º—ã—Å–ª–∏ –æ —Å–µ–±–µ. –≠—Ç–æ –º–æ–≥—É—Ç –±—ã—Ç—å —Ñ—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –∫—Ä—É—Ç—è—Ç—Å—è –≤ –≥–æ–ª–æ–≤–µ.

        ‚ùì **–§–∏–∫—Å–∏—Ä—É–π—Ç–µ —Å–æ–º–Ω–µ–Ω–∏—è:** –õ—é–±—ã–µ –º—ã—Å–ª–∏, –≤—ã—Ä–∞–∂–∞—é—â–∏–µ –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–µ–±–µ, —Å–≤–æ–∏—Ö —Å–∏–ª–∞—Ö, –ø—Ä–∞–≤–µ –Ω–∞ —Å—á–∞—Å—Ç—å–µ –∏–ª–∏ —É—Å–ø–µ—Ö.

        üìâ **–û–ø–∏—Å—ã–≤–∞–π—Ç–µ –æ—â—É—â–µ–Ω–∏—è "–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏":** –ï—Å–ª–∏ —á—É–≤—Å—Ç–≤—É–µ—Ç–µ, —á—Ç–æ –≤—ã "–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ä–æ—à–∏/—É–º–Ω—ã/–∫—Ä–∞—Å–∏–≤—ã/–¥–æ—Å—Ç–æ–π–Ω—ã" ‚Äì –∑–∞–ø–∏—à–∏—Ç–µ —ç—Ç–æ.

        üíØ **–ë—É–¥—å—Ç–µ —á–µ—Å—Ç–Ω—ã:** –ù–µ –±–æ–π—Ç–µ—Å—å "–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö" –∏–ª–∏ "—Å—Ç—ã–¥–Ω—ã—Ö" –º—ã—Å–ª–µ–π. –ß–µ–º –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–µ–µ, —Ç–µ–º —Ç–æ—á–Ω–µ–µ –±—É–¥–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞.

        **–ü—Ä–∏–º–µ—Ä—ã –¥–ª—è —Å—Ç–∞—Ä—Ç–∞:**
        ‚Ä¢ "–Ø –≤—Å–µ–≥–¥–∞ –≤—Å–µ –ø–æ—Ä—á—É"
        ‚Ä¢ "–Ø –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É–º–Ω—ã–π(–∞—è)"
        ‚Ä¢ "–ú–µ–Ω—è —Å–ª–æ–∂–Ω–æ –ª—é–±–∏—Ç—å"
        ‚Ä¢ "–Ø –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–º–æ–≥—É –∏–∑–º–µ–Ω–∏—Ç—å—Å—è"
        ‚Ä¢ "–Ø –Ω–µ –∑–∞—Å–ª—É–∂–∏–≤–∞—é —É—Å–ø–µ—Ö–∞"

        –ì–ª–∞–≤–Ω–æ–µ ‚Äì –∑–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Ç–µ –º—ã—Å–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç —É –≤–∞—Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç –∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç –≤–∞—Å.
    next_step: request_ya_ya_input

  - id: request_ya_ya_input
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: "–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏ —Å–≤–æ–∏ –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã –≤ —Å—Ñ–µ—Ä–µ ¬´–Ø-–Ø¬ª. –ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —á–µ—Å—Ç–µ–Ω —Å —Å–æ–±–æ–π."
      buttons:
        - text: "–ù–∞–ø–∏—Å–∞—Ç—å –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã ¬´–Ø-–Ø¬ª"
          callback_data: "ready_to_write"
    next_step: wait_for_ready_signal

  - id: wait_for_ready_signal
    type: input_button
    params:
      variable: "user_choice"
      timeout_seconds: 3600
    next_step: collect_ya_ya_response

  - id: collect_ya_ya_response
    type: input_text
    params:
      variable: "ya_ya_response"
      prompt: "–ù–∞–ø–∏—à–∏ —Å–≤–æ–∏ –º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã ¬´–Ø-–Ø¬ª:"
      timeout_seconds: 3600  # 1 —á–∞—Å –Ω–∞ –æ—Ç–≤–µ—Ç
    next_step: save_ya_ya_response

  - id: save_ya_ya_response
    type: action
    params:
      action_type: "update_context"
      updates:
        ya_ya_response: "{ya_ya_response}"
    next_step: save_to_database

  - id: save_to_database
    type: mongo_insert_document
    params:
      collection: "diagnostic_responses"
      document:
        user_id: "{user_id}"
        chat_id: "{chat_id}"
        stage: "ya_ya"
        response: "{ya_ya_response}"
        timestamp: "{current_timestamp}"
        session_id: "{session_id}"
    next_step: update_amocrm_contact

  - id: update_amocrm_contact
    type: amocrm_update_contact
    params:
      contact_id: "{amocrm_contact.contact_id}"
      custom_fields:
        DIAGNOSTIC_STAGE: "ya_ya_completed"
        YA_YA_RESPONSE: "{ya_ya_response}"
        YA_YA_COMPLETED_AT: "{current_timestamp}"
      output_var: "amocrm_update_result"
    next_step: add_ya_ya_note

  - id: add_ya_ya_note
    type: amocrm_add_note
    params:
      entity_type: "contacts"
      entity_id: "{amocrm_contact.contact_id}"
      note_type: "common"
      text: |
        ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ "–Ø-–Ø" –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        
        üìÖ –î–∞—Ç–∞: {current_timestamp}
        üìù –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
        {ya_ya_response}
        
        –°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ "–Ø-–î–µ–ª–æ"
    next_step: confirm_and_proceed

  - id: confirm_and_proceed
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: "–ë–ª–∞–≥–æ–¥–∞—Ä—é, —Ç–µ–ø–µ—Ä—å —Å–º–æ—Ç—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–µ –≤–∏–¥–µ–æ –∏ –≤—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞–Ω–∏–µ."
    next_step: update_stage_and_switch

  - id: update_stage_and_switch
    type: action
    params:
      action_type: "update_context"
      updates:
        current_stage: "diagnostic_ya_delo"
    next_step: switch_to_ya_delo

  - id: switch_to_ya_delo
    type: switch_scenario
    params:
      scenario_id: "mr_ontobot_diagnostic_ya_delo"
      preserve_context: true
    next_step: end

  - id: end
    type: end 