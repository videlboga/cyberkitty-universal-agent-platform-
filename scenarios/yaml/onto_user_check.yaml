scenario_id: onto_user_check
description: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î, —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –∑–∞–ø—É—Å–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"
version: "1.0"

steps:
  - id: start
    type: start
    next_step: find_user

  - id: find_user
    type: mongo_find_one_document
    params:
      collection: users
      filter:
        telegram_user_id: "{user_id}"
    next_step: check_user_exists

  - id: check_user_exists
    type: branch
    params:
      condition: "{mongo_result}"
      true_step: user_exists
      false_step: create_user

  - id: user_exists
    type: log_message
    params:
      message: "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î"
      level: info
    next_step: check_registration_status

  - id: check_registration_status
    type: branch
    params:
      condition: "{mongo_result.registration_completed}"
      true_step: start_main_flow
      false_step: continue_registration

  - id: create_user
    type: mongo_insert_document
    params:
      collection: users
      document:
        telegram_user_id: "{user_id}"
        chat_id: "{chat_id}"
        username: "{telegram_data.username}"
        first_name: "{telegram_data.first_name}"
        last_name: "{telegram_data.last_name}"
        registration_completed: false
        created_at: "{current_timestamp}"
        source: "telegram_bot"
        status: "new"
    next_step: create_amocrm_contact

  - id: create_amocrm_contact
    type: amocrm_create_contact
    params:
      name: "{telegram_data.first_name} {telegram_data.last_name}"
      phone: ""
      email: ""
      custom_fields:
        telegram_user_id: "{user_id}"
        telegram_username: "{telegram_data.username}"
        source: "telegram_bot"
    next_step: update_user_with_amocrm

  - id: update_user_with_amocrm
    type: mongo_update_document
    params:
      collection: users
      filter:
        telegram_user_id: "{user_id}"
      document:
        amocrm_contact_id: "{amocrm_contact_id}"
        updated_at: "{current_timestamp}"
    next_step: welcome_new_user

  - id: welcome_new_user
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üåü –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ONTO –∫–æ—É—á–∏–Ω–≥!
        
        üß† ONTO –∫–æ—É—á–∏–Ω–≥ - —ç—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤–∞—à–µ–≥–æ —Å–ø–æ—Å–æ–±–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è.
        
        üí° –ú—ã –ø–æ–º–æ–∂–µ–º –≤–∞–º:
        ‚Ä¢ –û—Å–æ–∑–Ω–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏–µ —É–±–µ–∂–¥–µ–Ω–∏—è
        ‚Ä¢ –†–∞—Å—à–∏—Ä–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–µ–π—Å—Ç–≤–∏–π
        ‚Ä¢ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ —Å–ø–æ—Å–æ–±—ã –±—ã—Ç–∏—è
        ‚Ä¢ –î–æ—Å—Ç–∏—á—å –∞—É—Ç–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏
        
        üöÄ –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
        1Ô∏è‚É£ –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        2Ô∏è‚É£ –ì–ª—É–±–æ–∫–∏–π –æ–ø—Ä–æ—Å –æ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏
        3Ô∏è‚É£ –ò–ò –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ª–∏—á–Ω–æ—Å—Ç–∏
        4Ô∏è‚É£ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ä–∞–∑–≤–∏—Ç–∏—è
        
        üìù –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏!
      parse_mode: HTML
    next_step: start_registration

  - id: continue_registration
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ!
        
        üìù –ü—Ä–æ–¥–æ–ª–∂–∏–º –≤–∞—à—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ ONTO –∫–æ—É—á–∏–Ω–≥.
      parse_mode: HTML
    next_step: start_registration

  - id: start_main_flow
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üéØ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ONTO –∫–æ—É—á–∏–Ω–≥!
        
        ‚úÖ –í–∞—à–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.
        
        üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É...
      parse_mode: HTML
    next_step: switch_to_access_check

  - id: start_registration
    type: switch_scenario
    params:
      scenario_id: onto_registration
      reason: "Starting registration process"

  - id: switch_to_access_check
    type: switch_scenario
    params:
      scenario_id: onto_access_check
      reason: "User already registered, checking access"

  - id: end
    type: end 