{
  "scenario_id": "ai_mentor_flow",
  "name": "AI-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫",
  "description": "–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∫—É—Ä—Å–∞ –∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
  "version": "1.0",
  
  "steps": [
    {
      "id": "start",
      "type": "start",
      "next_step": "load_user_context"
    },
    {
      "id": "load_user_context",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_mongo_find_data",
        "context_updates": {
          "collection": "users",
          "filter": {"user_id": "{user_id}"},
          "find_one": true,
          "output_var": "user_profile"
        }
      },
      "next_step": "log_question"
    },
    {
      "id": "log_question",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_log_message",
        "context_updates": {
          "message": "AI-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å: {message_text}",
          "level": "INFO",
          "category": "ai_mentor"
        }
      },
      "next_step": "search_knowledge"
    },
    {
      "id": "search_knowledge",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_rag_search",
        "context_updates": {
          "query": "{message_text}",
          "collection": "course_materials",
          "limit": 3,
          "threshold": 0.7,
          "output_var": "relevant_materials"
        }
      },
      "next_step": "check_materials_found"
    },
    {
      "id": "check_materials_found",
      "type": "conditional_branch",
      "params": {
        "condition": "{rag_found_count} > 0",
        "if_true_step": "check_user_level",
        "if_false_step": "no_materials_response"
      }
    },
    {
      "id": "check_user_level",
      "type": "conditional_branch",
      "params": {
        "condition": "exists({user_profile})",
        "if_true_step": "generate_personalized_answer",
        "if_false_step": "generate_generic_answer"
      }
    },
    {
      "id": "generate_personalized_answer",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_llm_query",
        "context_updates": {
          "prompt": "–¢—ã - AI-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å —Å—Ç—É–¥–µ–Ω—Ç–∞, —É—á–∏—Ç—ã–≤–∞—è –µ–≥–æ —É—Ä–æ–≤–µ–Ω—å –∏ —Ü–µ–ª–∏:\n\n–í–æ–ø—Ä–æ—Å: {message_text}\n\n–ü—Ä–æ—Ñ–∏–ª—å —Å—Ç—É–¥–µ–Ω—Ç–∞:\n- –û–ø—ã—Ç: {user_profile.experience_level}\n- –¶–µ–ª–∏: {user_profile.learning_goals}\n- –ò–Ω—Ç–µ—Ä–µ—Å—ã: {user_profile.interests}\n- –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: {user_profile.preferred_format}\n\n–ù–∞–π–¥–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:\n{rag_best_match}\n\n–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É:\n1. –ê–¥–∞–ø—Ç–∏—Ä—É–π —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å —Å—Ç—É–¥–µ–Ω—Ç–∞\n2. –°–≤—è–∑—ã–≤–∞–π —Å –µ–≥–æ —Ü–µ–ª—è–º–∏ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏\n3. –ü—Ä–µ–¥–ª–∞–≥–∞–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã\n4. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –æ–±—É—á–µ–Ω–∏—è\n5. –ë—É–¥—å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–æ–º, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n\n–§–æ—Ä–º–∞—Ç: HTML —Å —ç–º–æ–¥–∑–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç.",
          "model": "meta-llama/llama-3.2-70b-instruct",
          "temperature": 0.3,
          "max_tokens": 1500,
          "output_var": "mentor_answer"
        }
      },
      "next_step": "save_interaction"
    },
    {
      "id": "generate_generic_answer",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_llm_query",
        "context_updates": {
          "prompt": "–¢—ã - AI-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å —Å—Ç—É–¥–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:\n\n–í–æ–ø—Ä–æ—Å: {message_text}\n\n–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞:\n{rag_best_match}\n\n–î–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π, –ø–æ–Ω—è—Ç–Ω—ã–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç. –í–∫–ª—é—á–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏–∑—É—á–µ–Ω–∏—è.\n\n–§–æ—Ä–º–∞—Ç: HTML —Å —ç–º–æ–¥–∑–∏.",
          "model": "meta-llama/llama-3.2-70b-instruct",
          "temperature": 0.3,
          "max_tokens": 1500,
          "output_var": "mentor_answer"
        }
      },
      "next_step": "save_interaction"
    },
    {
      "id": "no_materials_response",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_llm_query",
        "context_updates": {
          "prompt": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å: {message_text}\n\n–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. –î–∞–π –æ–±—â–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–Ω–∞–Ω–∏–π –æ–± –ò–ò –∏ –º–∞—à–∏–Ω–Ω–æ–º –æ–±—É—á–µ–Ω–∏–∏. –ë—É–¥—å —á–µ—Å—Ç–Ω—ã–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –∏–∑ –∫—É—Ä—Å–æ–≤—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, –Ω–æ –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –ø–æ–º–æ—á—å.\n\n–§–æ—Ä–º–∞—Ç: HTML —Å —ç–º–æ–¥–∑–∏.",
          "model": "meta-llama/llama-3.2-70b-instruct",
          "temperature": 0.4,
          "max_tokens": 1000,
          "output_var": "mentor_answer"
        }
      },
      "next_step": "save_interaction"
    },
    {
      "id": "save_interaction",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_mongo_save_data",
        "context_updates": {
          "collection": "mentor_interactions",
          "document": {
            "user_id": "{user_id}",
            "chat_id": "{chat_id}",
            "question": "{message_text}",
            "answer": "{mentor_answer}",
            "materials_found": "{rag_found_count}",
            "personalized": "exists({user_profile})",
            "created_at": "{current_time}"
          }
        }
      },
      "next_step": "send_answer"
    },
    {
      "id": "send_answer",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_message",
        "context_updates": {
          "text": "üë®‚Äçüè´ <b>–û—Ç–≤–µ—Ç –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞:</b>\n\n{mentor_answer}",
          "parse_mode": "HTML"
        }
      },
      "next_step": "offer_additional_help"
    },
    {
      "id": "offer_additional_help",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_buttons",
        "context_updates": {
          "text": "üí° <b>–ù—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–º–æ—â—å?</b>",
          "buttons": [
            [{"text": "üìö –ü–æ–∫–∞–∑–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã", "callback_data": "show_materials"}],
            [{"text": "‚ùì –ó–∞–¥–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å", "callback_data": "ask_followup"}],
            [{"text": "‚úÖ –°–ø–∞—Å–∏–±–æ, –ø–æ–Ω—è—Ç–Ω–æ", "callback_data": "mentor_done"}]
          ]
        }
      },
      "next_step": "wait_user_choice"
    },
    {
      "id": "wait_user_choice",
      "type": "input",
      "params": {
        "input_type": "callback_query",
        "timeout_seconds": 120,
        "output_var": "user_choice"
      },
      "next_step": "handle_choice"
    },
    {
      "id": "handle_choice",
      "type": "conditional_branch",
      "params": {
        "condition": "{user_choice} == 'show_materials'",
        "if_true_step": "show_materials",
        "if_false_step": "check_followup"
      }
    },
    {
      "id": "check_followup",
      "type": "conditional_branch",
      "params": {
        "condition": "{user_choice} == 'ask_followup'",
        "if_true_step": "prompt_followup",
        "if_false_step": "end"
      }
    },
    {
      "id": "show_materials",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_message",
        "context_updates": {
          "text": "üìö <b>–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:</b>\n\n{relevant_materials}\n\n<i>üí° –†–µ–∫–æ–º–µ–Ω–¥—É—é –∏–∑—É—á–∏—Ç—å —ç—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç–µ–º—ã.</i>",
          "parse_mode": "HTML"
        }
      },
      "next_step": "end"
    },
    {
      "id": "prompt_followup",
      "type": "switch_scenario",
      "params": {
        "target_scenario": "atomic_telegram_send_message",
        "context_updates": {
          "text": "‚ùì <b>–ó–∞–¥–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å</b>\n\n–Ø –≥–æ—Ç–æ–≤ –æ–±—ä—è—Å–Ω–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –ª—é–±–æ–π –∞—Å–ø–µ–∫—Ç —Ç–µ–º—ã. –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å.",
          "parse_mode": "HTML"
        }
      },
      "next_step": "end"
    },
    {
      "id": "end",
      "type": "end"
    }
  ]
} 