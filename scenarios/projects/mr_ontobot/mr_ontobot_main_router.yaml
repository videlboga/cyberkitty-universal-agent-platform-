scenario_id: "mr_ontobot_main_router"
name: "Mr OntoBot –ì–ª–∞–≤–Ω—ã–π –†–æ—É—Ç–µ—Ä"
description: "–û—Å–Ω–æ–≤–Ω–æ–π —Ä–æ—É—Ç–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–æ—Ä–æ–Ω–∫–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤"

initial_context:
  bot_name: "mr_ontobot"
  current_stage: "entry"
  access_timer_hours: 24
  access_granted_at: null
  diagnostic_started: false
  contact_provided: false
  dossier_generated: false

steps:
  - id: start
    type: start
    next_step: check_user_stage

  - id: check_user_stage
    type: branch
    params:
      conditions:
        - condition: "{current_stage} == 'entry'"
          next_step: welcome_sequence
        - condition: "{current_stage} == 'diagnostic_ya_ya'"
          next_step: switch_to_ya_ya
        - condition: "{current_stage} == 'diagnostic_ya_delo'"
          next_step: switch_to_ya_delo
        - condition: "{current_stage} == 'diagnostic_ya_relations'"
          next_step: switch_to_ya_relations
        - condition: "{current_stage} == 'waiting_contact'"
          next_step: switch_to_contact_collection
        - condition: "{current_stage} == 'waiting_dossier'"
          next_step: switch_to_dossier_feedback
        - condition: "{current_stage} == 'product_offer'"
          next_step: switch_to_product_offer
      default_next_step: welcome_sequence

  # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  - id: welcome_sequence
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        üëã –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äì –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø—Ä–æ–µ–∫—Ç–∞ Onto Nothing.

        –Ø –ø–æ–º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, –∫–∞–∫–∏–µ —Å–∫—Ä—ã—Ç—ã–µ '–º—ã—Å–ª–µ–≤–∏—Ä—É—Å—ã' –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ–∑–∞–º–µ—Ç–Ω–æ –≤–ª–∏—è—é—Ç –Ω–∞ —Ç–≤–æ–∏ —Ü–µ–ª–∏, –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –æ—â—É—â–µ–Ω–∏–µ —Å—á–∞—Å—Ç—å—è –∏ —Å–≤–æ–±–æ–¥—ã üöÄ

        –Ø —Å–æ–±–µ—Ä—É –¥–ª—è —Ç–µ–±—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–≤–æ–∏—Ö —Ç–µ–∫—É—â–∏—Ö —É–±–µ–∂–¥–µ–Ω–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–±–æ–π —É–ø—Ä–∞–≤–ª—è—é—Ç. –ò —Ç–≤–æ–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —á–µ—Å—Ç–Ω—ã–µ –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–∑–≤–æ–ª—è—Ç –º–æ–µ–º—É –ò–ò-–∞–ª–≥–æ—Ä–∏—Ç–º—É –ø—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫—É—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É, –∫–æ—Ç–æ—Ä–∞—è –æ–±—ã—á–Ω–æ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è –∑–∞ 10-20 —Å–µ—Å—Å–∏–π —Å –ø—Å–∏—Ö–æ–ª–æ–≥–æ–º –∏ —Å—Ç–æ–∏—Ç –æ—Ç 30 000 —Ä—É–±–ª–µ–π.
    next_step: welcome_message_2

  - id: welcome_message_2
    type: channel_action
    params:
      action: send_message
      chat_id: "{chat_id}"
      text: |
        –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Ç—ã –ø–æ–ª—É—á–∏—à—å:
        - –ß–µ—Ç–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Å–≤–æ–∏—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö '–º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤'
        - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Ö –Ω–µ–π—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏
        - –ü—Ä–æ–≥–Ω–æ–∑ —Ä–∞–∑–≤–∏—Ç–∏—è —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏ –Ω–∞ 1, 3 –∏ 5 –ª–µ—Ç ‚Äì –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –ø—Ä–æ–¥–æ–ª–∂–∏—à—å –ª–∏ —Ç—ã –∂–∏—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏ –∏–ª–∏ –Ω–∞—á–Ω–µ—à—å –∏—Ö —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å

        –≠—Ç–æ —Ç–≤–æ–π –ø–µ—Ä–≤—ã–π —à–∞–≥ –∫ —è—Å–Ω–æ—Å—Ç–∏ —É–º–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Å–≤–æ–µ–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é! ‚ú®

        –ê —Ç–µ–ø–µ—Ä—å –ø–æ—Å–º–æ—Ç—Ä–∏ –≤–∏–¥–µ–æ ‚Üí
    next_step: send_diagnostic_video

  - id: send_diagnostic_video
    type: channel_action
    params:
      action: forward_message
      chat_id: "{chat_id}"
      from_chat_id: "-1002614708769"
      message_id: 2  # ID –≤–∏–¥–µ–æ "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤" - –ø–µ—Ä–≤–æ–µ –≤–∏–¥–µ–æ –≤ –∫–∞–Ω–∞–ª–µ
    next_step: offer_start_diagnostic

  - id: offer_start_diagnostic
    type: channel_action
    params:
      action: send_buttons
      chat_id: "{chat_id}"
      text: |
        –ê —Ç–µ–ø–µ—Ä—å –¥–∞–≤–∞–π –Ω–∞—á–Ω–µ–º –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É!

        –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É '–ü—Ä–æ–π—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É', —Ç—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—à—å –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≥–ª–∞—à–∞–µ—à—å—Å—è —Å —É—Å–ª–æ–≤–∏—è–º–∏.

        –ú—ã —Ü–µ–Ω–∏–º —Ç–≤–æ–µ –¥–æ–≤–µ—Ä–∏–µ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

        üìã [–ü—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞](https://example.com/offer)
        üîí [–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö](https://example.com/privacy)
        üìÑ [–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏](https://example.com/policy)
        üì¢ [–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è](https://example.com/notifications)
      buttons:
        - - text: "–ù–∞—á–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É"
            callback_data: "start_diagnostic"
    next_step: wait_for_diagnostic_start

  - id: wait_for_diagnostic_start
    type: input
    params:
      waiting_for: "callback_query"
      expected_values: ["start_diagnostic"]
    next_step: start_diagnostic_flow

  - id: start_diagnostic_flow
    type: action
    params:
      action_type: "update_context"
      updates:
        current_stage: "diagnostic_ya_ya"
        diagnostic_started: true
        access_granted_at: "{current_timestamp}"
    next_step: create_amocrm_contact

  # –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –¥—Ä—É–≥–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
  - id: switch_to_ya_ya
    type: switch_scenario
    params:
      scenario_id: "mr_ontobot_diagnostic_ya_ya"
      preserve_context: true
    next_step: end

  # AmoCRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è - –∑–∞–ø–∏—Å—å —Å—Ç–∞—Ä—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
  - id: create_amocrm_contact
    type: amocrm_create_contact
    params:
      name: "{telegram_first_name} {telegram_last_name}"
      phone: "{phone_number}"
      custom_fields:
        TELEGRAM_ID: "{user_id}"
        CHAT_ID: "{chat_id}"
        DIAGNOSTIC_STAGE: "started"
        ENTRY_DATE: "{current_timestamp}"
      output_var: "amocrm_contact"
    next_step: add_diagnostic_start_note

  - id: add_diagnostic_start_note
    type: amocrm_add_note
    params:
      entity_type: "contacts"
      entity_id: "{amocrm_contact.contact_id}"
      note_type: "common"
      text: |
        üéØ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –º—ã—Å–ª–µ–≤–∏—Ä—É—Å–æ–≤
        
        üìÖ –î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞: {current_timestamp}
        üí¨ Telegram: @{telegram_username}
        üÜî User ID: {user_id}
        üó£ Chat ID: {chat_id}
        
        –≠—Ç–∞–ø: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ —Å–æ–≥–ª–∞—Å–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã
        –°–ª–µ–¥—É—é—â–∏–π: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ø-–Ø
    next_step: switch_to_ya_ya

  - id: switch_to_ya_delo
    type: switch_scenario
    params:
      scenario_id: "mr_ontobot_diagnostic_ya_delo"
      preserve_context: true
    next_step: end

  - id: switch_to_ya_relations
    type: switch_scenario
    params:
      scenario_id: "mr_ontobot_diagnostic_ya_relations"
      preserve_context: true
    next_step: end

  - id: switch_to_contact_collection
    type: switch_scenario
    params:
      scenario_id: "mr_ontobot_contact_collection"
      preserve_context: true
    next_step: end

  - id: switch_to_dossier_feedback
    type: switch_scenario
    params:
      scenario_id: "mr_ontobot_dossier_feedback"
      preserve_context: true
    next_step: end

  - id: switch_to_product_offer
    type: switch_scenario
    params:
      scenario_id: "mr_ontobot_product_offer"
      preserve_context: true
    next_step: end

  - id: end
    type: end 